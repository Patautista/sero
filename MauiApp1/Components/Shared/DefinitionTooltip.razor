@using Business.Interfaces
@using MauiApp1.Components.Shared

@if (IsVisible && DefinitionResult != null)
{
    <!-- Backdrop for tooltip (click to close) -->
    <div class="tooltip-backdrop" 
         @onclick="OnClose"
         style="position: fixed; 
                top: 0; 
                left: 0; 
                right: 0; 
                bottom: 0; 
                z-index: 999;
                background: transparent;">
    </div>

    <!-- Tooltip for component definitions -->
    <div class="definition-tooltip" 
         style="position: fixed; 
                left: @(X)px; 
                top: @(Y)px; 
                transform: translateX(-50%) translateY(-110%);
                z-index: 1000;
                min-width: 300px;
                max-width: 400px;"
         @onclick:stopPropagation="true">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-indigo-600 text-white d-flex justify-content-between align-items-center py-2">
                <h6 class="mb-0">
                    <i class="fa fa-book me-2"></i>
                    @DefinitionResult.Word
                </h6>
                <button type="button" 
                        class="btn-close btn-close-white btn-sm" 
                        @onclick="OnClose"
                        @onclick:stopPropagation="true"></button>
            </div>
            <div class="card-body p-3" style="max-height: 400px; overflow-y: auto;">
                @if (IsLoading)
                {
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="small text-muted mt-2 mb-0">
                            <Translate Text="Carregando definição..."></Translate>
                        </p>
                    </div>
                }
                else if (DefinitionResult.Entries != null && DefinitionResult.Entries.Any())
                {
                    @foreach (var entry in DefinitionResult.Entries.Take(MaxEntries))
                    {
                        <div class="mb-2">
                            @if (!string.IsNullOrEmpty(entry.PartOfSpeech))
                            {
                                <span class="badge bg-primary text-xs mb-1">@entry.PartOfSpeech</span>
                            }
                            @if (!string.IsNullOrEmpty(entry.Pronunciation))
                            {
                                <div class="text-muted small mb-1">
                                    /@entry.Pronunciation/
                                </div>
                            }
                            @if (entry.Meanings != null && entry.Meanings.Any())
                            {
                                @foreach (var meaning in entry.Meanings.Take(MaxMeaningsPerEntry))
                                {
                                    <div class="small mb-2">
                                        @if (!string.IsNullOrEmpty(meaning.Definition))
                                        {
                                            <div class="text-primary fw-semibold">
                                                @meaning.Definition
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(meaning.Translation))
                                        {
                                            <div class="text-success">
                                                ? @meaning.Translation
                                            </div>
                                        }
                                        @if (meaning.Examples != null && meaning.Examples.Any())
                                        {
                                            @foreach (var example in meaning.Examples.Take(2))
                                            {
                                                <div class="text-muted fst-italic small mt-1">
                                                    • @example
                                                </div>
                                            }
                                        }
                                    </div>
                                }
                            }
                        </div>
                    }
                    @if (DefinitionResult.Entries.Count() > MaxEntries || 
                         DefinitionResult.Entries.First().Meanings.Count() > MaxMeaningsPerEntry)
                    {
                        <small class="text-muted fst-italic">
                            <i class="fa fa-info-circle me-1"></i>
                            <Translate Text="Mostrando primeiros resultados..."></Translate>
                        </small>
                    }
                }
                else
                {
                    <p class="text-muted small mb-0">
                        <Translate Text="Nenhuma definição encontrada"></Translate>
                    </p>
                }
            </div>
        </div>
    </div>
}

<style>
    .definition-tooltip {
        animation: fadeInUp 0.2s ease;
    }

    .definition-tooltip .card {
        border-radius: 8px;
        overflow: hidden;
    }

    .definition-tooltip .card-body::-webkit-scrollbar {
        width: 6px;
    }

    .definition-tooltip .card-body::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .definition-tooltip .card-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .definition-tooltip .card-body::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-100%);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(-110%);
        }
    }
</style>

@code {
    /// <summary>
    /// Whether the tooltip is visible
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// Whether the definition is currently loading
    /// </summary>
    [Parameter]
    public bool IsLoading { get; set; }

    /// <summary>
    /// The definition result to display
    /// </summary>
    [Parameter]
    public DefinitionResult? DefinitionResult { get; set; }

    /// <summary>
    /// X position of the tooltip in pixels
    /// </summary>
    [Parameter]
    public double X { get; set; }

    /// <summary>
    /// Y position of the tooltip in pixels
    /// </summary>
    [Parameter]
    public double Y { get; set; }

    /// <summary>
    /// Maximum number of entries to display
    /// </summary>
    [Parameter]
    public int MaxEntries { get; set; } = 2;

    /// <summary>
    /// Maximum number of meanings per entry to display
    /// </summary>
    [Parameter]
    public int MaxMeaningsPerEntry { get; set; } = 3;

    /// <summary>
    /// Event callback when the tooltip is closed
    /// </summary>
    [Parameter]
    public EventCallback OnClose { get; set; }
}
