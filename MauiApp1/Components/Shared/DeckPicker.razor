@using Infrastructure.Data.Model
@using Business.Interfaces
@using Business.MobileConfig
@inject MauiApp1.Services.DatabaseService DatabaseService
@inject ISettingsService SettingsService

 <!-- <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Deck</label> -->
<select @bind="SelectedDeckId" @bind:after="OnDeckChangedAfterBind" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
    <option value="0">-- Escolha um deck --</option>
    @foreach (var deck in filteredDecks)
    {
        <option value="@deck.Id">@deck.Name (@deck.TargetLanguage)</option>
    }
</select>

@code {
    [Parameter] public int SelectedDeckId { get; set; }
    [Parameter] public EventCallback<int> SelectedDeckIdChanged { get; set; }

    private List<DeckTable> decks = new();
    private List<DeckTable> filteredDecks = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDecks();
    }

    private async Task LoadDecks()
    {
        decks = await DatabaseService.GetAllDecksAsync();
        
        // Apply language filter
        var config = SettingsService.StudyConfig.Value;
        var languageFilter = config?.SelectedTargetLanguageFilter;
        
        if (!string.IsNullOrEmpty(languageFilter))
        {
            filteredDecks = decks.Where(d => d.TargetLanguage == languageFilter).ToList();
        }
        else
        {
            filteredDecks = decks;
        }
        
        // Initialize with the last used deck if available
        if (SelectedDeckId == 0)
        {
            var lastDeckId = config?.LastSelectedDeckId ?? 0;
            
            if (lastDeckId > 0 && filteredDecks.Any(d => d.Id == lastDeckId))
            {
                SelectedDeckId = lastDeckId;
            }
            else if (filteredDecks.Any())
            {
                SelectedDeckId = filteredDecks[0].Id;
            }
            
            await SelectedDeckIdChanged.InvokeAsync(SelectedDeckId);
        }
    }

    private async Task OnDeckChangedAfterBind()
    {
        // Save the selected deck to settings
        if (SelectedDeckId > 0)
        {
            var config = SettingsService.StudyConfig.Value ?? StudyConfig.Default;
            config.LastSelectedDeckId = SelectedDeckId;
            SettingsService.StudyConfig.Update(config);
        }
        
        await SelectedDeckIdChanged.InvokeAsync(SelectedDeckId);
    }
}