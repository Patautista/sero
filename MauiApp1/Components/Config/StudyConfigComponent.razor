@using System.Globalization
@using Business.Interfaces
@using Business.MobileConfig
@using Infrastructure.Services
@inject ISettingsService SettingsService
@inject NavigationManager Nav

<EditForm Model="@config" OnValidSubmit="ApplyStudyConfig">
                    <div class="mb-3">
                        <label class="form-label">Escolha o Idioma</label>
                        <select class="form-select" @bind="selectedLanguageCode">
                            @foreach (var pair in AvailabilityService.TargetLanguages.Select(c => new { Code = c, DisplayName = new CultureInfo(c).DisplayName }))
                            {
                                <option value="@pair.Code">@pair.DisplayName</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Dificuldade Inicial</label>
                        <select class="form-select" @bind="config.DifficultyLevel">
                            @foreach (var level in Enum.GetValues<DifficultyLevel>())
                            {
                                <option value="@level">@level</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoSkipSwitch" @bind="config.AutoSkip">
                            <label class="form-check-label" for="autoSkipSwitch">
                                Pular automaticamente para o próximo card
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            Quando desativado, você precisará clicar em "Próximo" após conferir a resposta.
                        </small>
                    </div>

                    <ButtonPrimary Type="submit">Salvar</ButtonPrimary>
</EditForm>

@code {
    private StudyConfig? config;
    private string selectedLanguageCode;

    protected override async Task OnInitializedAsync()
    {
        config = SettingsService.StudyConfig.Value ?? StudyConfig.Default;

        // Sync UI dropdown with current config
        var code = $"{config.SelectedLanguage.Source.TwoLetterISOLanguageName}-{config.SelectedLanguage.Target.TwoLetterISOLanguageName}";
        selectedLanguageCode = code;
    }

    private async Task ApplyStudyConfig()
    {
        // Map dropdown code back to LanguagePair
        var lang = AvailabilityService.TargetLanguages.FirstOrDefault(l => l == selectedLanguageCode);
        config.SelectedLanguage = new LanguagePair
        {
            Source = config.SelectedLanguage.Source,
            Target = new(lang)
        };

        SettingsService.StudyConfig.Update(config);
        Nav.NavigateTo("/");
    }
}