@page "/explore"
@using Business.Interfaces
@using Business.MobileConfig
@using RssFeedWidgetModel = Business.MobileConfig.RssFeedWidget
@using System.Net.Http
@using System.Xml.Linq
@using System.Globalization
@inject ISettingsService SettingsService
@inject MauiApp1.Services.LanguageDetectionService LanguageDetector
@inject HttpClient Http
@inherits SmartComponent

<div class="p-4">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-indigo-700">
            <Translate Text="Explorar"></Translate>
        </h2>
    </div>

    <!-- Language Filter -->
    @if (_availableLanguages.Count > 1)
    {
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por idioma</label>
            <select @bind="_selectedLanguageFilter" 
                    @bind:after="ApplyLanguageFilter"
                    class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Todos os idiomas</option>
                @foreach (var lang in _availableLanguages.OrderBy(l => l.Value))
                {
                    <option value="@lang.Key">@lang.Value (@_languageCounts[lang.Key])</option>
                }
            </select>
        </div>
    }

    <!-- Edit Widget Modal -->
    @if (_editingWidget != null)
    {
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="CancelEdit">
            <div class="bg-white rounded-xl p-6 max-w-md w-full m-4" @onclick:stopPropagation="true">
                <h3 class="text-xl font-bold mb-4 text-indigo-700">Editar Widget</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input @bind="_editingWidget.Title" 
                               class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                        <input @bind="_editingWidget.Url" 
                               class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Máximo de Itens</label>
                        <input @bind="_editingWidget.MaxItems" 
                               type="number" 
                               min="1" 
                               max="20"
                               class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    <div class="flex gap-2 pt-3">
                        <button @onclick="SaveEdit"
                                class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Salvar
                        </button>
                        <button @onclick="CancelEdit"
                                class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Add Widget Modal -->
    @if (_showAddModal)
    {
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="CancelAdd">
            <div class="bg-white rounded-xl p-6 max-w-md w-full m-4" @onclick:stopPropagation="true">
                <h3 class="text-xl font-bold mb-4 text-indigo-700">➕ Adicionar Novo Feed</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input @bind="_newWidgetTitle" 
                               placeholder="ex: Notícias Tech"
                               class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">URL do Feed RSS</label>
                        <input @bind="_newWidgetUrl" 
                               placeholder="https://..."
                               class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Máximo de Itens</label>
                        <input @bind="_newWidgetMaxItems" 
                               type="number" 
                               min="1" 
                               max="20"
                               class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    @if (_isDetectingLanguage)
                    {
                        <div class="text-sm text-indigo-600">
                            🔍 Detectando idioma do feed...
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(_detectedLanguageMessage))
                    {
                        <div class="text-sm text-green-600">
                            ✓ @_detectedLanguageMessage
                        </div>
                    }
                    <div class="flex gap-2 pt-3">
                        <button @onclick="AddWidget"
                                class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                disabled="@_isDetectingLanguage">
                            Adicionar
                        </button>
                        <button @onclick="CancelAdd"
                                class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    <!-- Empty State -->
    @if (_filteredWidgets.Count == 0)
    {
        <div class="text-center p-12 bg-gray-50 rounded-xl mb-4">
            <p class="text-gray-500 text-lg mb-4">
                📰 @(_widgets.Count == 0 ? "Nenhum feed RSS configurado" : "Nenhum feed encontrado para o idioma selecionado")
            </p>
            <p class="text-gray-400 text-sm mb-4">
                @(_widgets.Count == 0 ? "Clique no botão + abaixo para adicionar seus feeds favoritos" : "Tente selecionar outro idioma ou adicione novos feeds")
            </p>
        </div>
    }
    <!-- RSS Feed Widgets -->
    <div class="space-y-4">
        @foreach (var widget in _filteredWidgets.OrderBy(w => w.DisplayOrder))
        {
            @if (widget.IsVisible)
            {
                <div class="relative">
                    @if (!string.IsNullOrEmpty(widget.LanguageCode))
                    {
                        <div class="absolute top-2 right-2 z-10 bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-medium">
                            @GetLanguageDisplayName(widget.LanguageCode)
                        </div>
                    }
                    <MauiApp1.Components.RssFeedWidget Widget="@widget"
                                   IsEditMode="@_isEditMode"
                                   OnEdit="@(w => StartEdit(w))" 
                                   OnDelete="@(w => DeleteWidget(w))"
                                   OnLongPress="@(w => EnableEditMode(w))" />
                </div>
            }
        }

        <!-- Add Widget Button -->
        <div class="flex justify-center">
            <button @onclick="ShowAddModal" 
                    class="w-16 h-16 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 hover:scale-110 transition flex items-center justify-center">
                <span class="text-3xl leading-none">+</span>
            </button>
        </div>
    </div>

    <!-- Exit Edit Mode Button (floating) -->
    @if (_isEditMode)
    {
        <div class="fixed bottom-8 right-8 z-40">
            <button @onclick="ExitEditMode" 
                    class="w-14 h-14 bg-green-600 text-white rounded-full shadow-2xl hover:bg-green-700 hover:scale-110 transition flex items-center justify-center">
                <span class="text-2xl leading-none">✓</span>
            </button>
        </div>
    }

    <!-- Wikipedia Section -->
    <div class="mt-8">
        <h3 class="text-xl font-semibold mb-3 text-center text-indigo-600">
            <Translate Text="Wikipédia"></Translate>
        </h3>
        <WikiCarousel></WikiCarousel>
    </div>

    
</div>

@code {
    private List<RssFeedWidgetModel> _widgets = new();
    private List<RssFeedWidgetModel> _filteredWidgets = new();
    private bool _isEditMode = false;
    private bool _showAddModal = false;
    private RssFeedWidgetModel? _editingWidget = null;

    // New widget fields
    private string _newWidgetTitle = string.Empty;
    private string _newWidgetUrl = string.Empty;
    private int _newWidgetMaxItems = 5;
    private bool _isDetectingLanguage = false;
    private string _detectedLanguageMessage = string.Empty;
    private string? _detectedLanguageCode = null;

    // Language filtering
    private string _selectedLanguageFilter = string.Empty;
    private Dictionary<string, string> _availableLanguages = new();
    private Dictionary<string, int> _languageCounts = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        LoadWidgets();
        UpdateLanguageFilter();
        ApplyLanguageFilter();
    }

    private void LoadWidgets()
    {
        var config = SettingsService.RssConfig.Value ?? RssConfig.Default;
        _widgets = config.Widgets ?? new List<RssFeedWidgetModel>();
    }

    private void SaveWidgets()
    {
        var config = new RssConfig { Widgets = _widgets };
        SettingsService.RssConfig.Update(config);
    }

    private void UpdateLanguageFilter()
    {
        _availableLanguages.Clear();
        _languageCounts.Clear();

        foreach (var widget in _widgets)
        {
            if (!string.IsNullOrEmpty(widget.LanguageCode))
            {
                if (!_availableLanguages.ContainsKey(widget.LanguageCode))
                {
                    _availableLanguages[widget.LanguageCode] = GetLanguageDisplayName(widget.LanguageCode);
                    _languageCounts[widget.LanguageCode] = 0;
                }
                _languageCounts[widget.LanguageCode]++;
            }
        }
    }

    private void ApplyLanguageFilter()
    {
        if (string.IsNullOrEmpty(_selectedLanguageFilter))
        {
            _filteredWidgets = _widgets.ToList();
        }
        else
        {
            _filteredWidgets = _widgets
                .Where(w => w.LanguageCode == _selectedLanguageFilter)
                .ToList();
        }
        StateHasChanged();
    }

    private string GetLanguageDisplayName(string languageCode)
    {
        try
        {
            var culture = new CultureInfo(languageCode);
            return culture.DisplayName;
        }
        catch
        {
            return languageCode.ToUpperInvariant();
        }
    }

    private void ShowAddModal()
    {
        _showAddModal = true;
    }

    private void CancelAdd()
    {
        _showAddModal = false;
        _newWidgetTitle = string.Empty;
        _newWidgetUrl = string.Empty;
        _newWidgetMaxItems = 5;
        _isDetectingLanguage = false;
        _detectedLanguageMessage = string.Empty;
        _detectedLanguageCode = null;
    }

    private async Task AddWidget()
    {
        if (string.IsNullOrWhiteSpace(_newWidgetTitle) || string.IsNullOrWhiteSpace(_newWidgetUrl))
            return;

        // Detect language from RSS feed content before adding
        if (_detectedLanguageCode == null)
        {
            await DetectFeedLanguage();
            if (_isDetectingLanguage)
                return; // Still detecting, wait for completion
        }

        var newWidget = new RssFeedWidgetModel
        {
            Title = _newWidgetTitle.Trim(),
            Url = _newWidgetUrl.Trim(),
            MaxItems = _newWidgetMaxItems,
            DisplayOrder = _widgets.Count,
            IsVisible = true,
            LanguageCode = _detectedLanguageCode
        };

        _widgets.Add(newWidget);
        SaveWidgets();
        UpdateLanguageFilter();
        ApplyLanguageFilter();

        // Reset and close
        CancelAdd();
        StateHasChanged();
    }

    private async Task DetectFeedLanguage()
    {
        if (string.IsNullOrWhiteSpace(_newWidgetUrl))
            return;

        _isDetectingLanguage = true;
        _detectedLanguageMessage = string.Empty;
        StateHasChanged();

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, _newWidgetUrl);
            request.Headers.UserAgent.ParseAdd("TriolingoApp/1.0 (https://github.com/tuapp)");

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var xmlContent = await response.Content.ReadAsStringAsync();
            var feedItems = ParseRssFeed(xmlContent);

            // Collect text from feed items for language detection
            var textSamples = feedItems
                .Take(5) // Use first 5 items for detection
                .Select(item => $"{item.Title} {item.Description}")
                .Where(text => !string.IsNullOrWhiteSpace(text))
                .ToList();

            if (textSamples.Any())
            {
                var combinedText = string.Join(" ", textSamples);
                _detectedLanguageCode = LanguageDetector.DetectLanguageCode(combinedText);

                if (!string.IsNullOrEmpty(_detectedLanguageCode))
                {
                    _detectedLanguageMessage = $"Idioma detectado: {GetLanguageDisplayName(_detectedLanguageCode)}";
                }
                else
                {
                    _detectedLanguageMessage = "Não foi possível detectar o idioma automaticamente";
                }
            }
            else
            {
                _detectedLanguageMessage = "Feed vazio - idioma não detectado";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error detecting feed language: {ex.Message}");
            _detectedLanguageMessage = "Erro ao detectar idioma do feed";
        }
        finally
        {
            _isDetectingLanguage = false;
            StateHasChanged();
        }
    }

    private List<FeedItem> ParseRssFeed(string xmlContent)
    {
        var items = new List<FeedItem>();
        
        try
        {
            var doc = XDocument.Parse(xmlContent);
            var channel = doc.Root?.Element("channel");
            
            if (channel == null)
            {
                return ParseAtomFeed(doc);
            }

            var itemElements = channel.Elements("item");

            foreach (var item in itemElements)
            {
                var feedItem = new FeedItem
                {
                    Title = item.Element("title")?.Value ?? "",
                    Description = StripHtml(item.Element("description")?.Value ?? "")
                };

                items.Add(feedItem);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing RSS feed: {ex.Message}");
        }

        return items;
    }

    private List<FeedItem> ParseAtomFeed(XDocument doc)
    {
        var items = new List<FeedItem>();
        XNamespace atom = "http://www.w3.org/2005/Atom";

        var entries = doc.Root?.Elements(atom + "entry");

        if (entries == null) return items;

        foreach (var entry in entries)
        {
            var feedItem = new FeedItem
            {
                Title = entry.Element(atom + "title")?.Value ?? "",
                Description = StripHtml(entry.Element(atom + "summary")?.Value ?? entry.Element(atom + "content")?.Value ?? "")
            };

            items.Add(feedItem);
        }

        return items;
    }

    private string StripHtml(string html)
    {
        if (string.IsNullOrEmpty(html)) return "";

        var text = System.Text.RegularExpressions.Regex.Replace(html, "<.*?>", string.Empty);
        text = System.Net.WebUtility.HtmlDecode(text);
        
        return text.Length > 300 ? text.Substring(0, 300) : text;
    }

    private void EnableEditMode(RssFeedWidgetModel widget)
    {
        _isEditMode = true;
        StateHasChanged();
    }

    private void ExitEditMode()
    {
        _isEditMode = false;
        StateHasChanged();
    }

    private void StartEdit(RssFeedWidgetModel widget)
    {
        // Create a copy for editing
        _editingWidget = new RssFeedWidgetModel
        {
            Id = widget.Id,
            Title = widget.Title,
            Url = widget.Url,
            MaxItems = widget.MaxItems,
            DisplayOrder = widget.DisplayOrder,
            IsVisible = widget.IsVisible,
            LanguageCode = widget.LanguageCode
        };
    }

    private void SaveEdit()
    {
        if (_editingWidget == null) return;

        var originalWidget = _widgets.FirstOrDefault(w => w.Id == _editingWidget.Id);
        if (originalWidget != null)
        {
            originalWidget.Title = _editingWidget.Title;
            originalWidget.Url = _editingWidget.Url;
            originalWidget.MaxItems = _editingWidget.MaxItems;
            
            SaveWidgets();
        }

        _editingWidget = null;
        StateHasChanged();
    }

    private void CancelEdit()
    {
        _editingWidget = null;
    }

    private async Task DeleteWidget(RssFeedWidgetModel widget)
    {
        var confirmed = await PromptConfirm($"Remover o widget '{widget.Title}'?");
        if (confirmed)
        {
            _widgets.Remove(widget);
            SaveWidgets();
            UpdateLanguageFilter();
            ApplyLanguageFilter();
            StateHasChanged();
        }
    }

    private class FeedItem
    {
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }
}