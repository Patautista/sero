@page "/session-select"
@using Infrastructure.Data.Model
@using Infrastructure.Services
@using MauiApp1.Components.Shared
@inject NavigationManager Navigation
@inject MauiApp1.Services.DatabaseService DatabaseService
@inherits SmartComponent

<div class="card flex flex-col items-center mb-5 p-3">
    <h2 class="text-2xl text-3xl font-bold mb-8 text-center text-indigo-700">
        <Translate Text="Nível atual:"></Translate> <b>@ExpCalculator.GetLevel(userExp)</b>
    </h2>

    <!-- Deck selection -->
    <div class="mb-4 w-full max-w-xs">
        <DeckPicker SelectedDeckIdChanged="OnDeckChanged" />
    </div>

    <!-- Deck info display -->
    @if (selectedDeck != null)
    {
        <div class="mb-4 w-full max-w-xs p-3 bg-indigo-50 rounded-lg border border-indigo-200">
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">Idioma alvo:</span>
                    <span class="text-sm font-semibold text-indigo-700">@TargetLanguage.DisplayName.FirstCharToUpper()</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700"><Translate Text="Novos cards:"></Translate></span>
                    <span class="badge bg-gradient-to-r from-indigo-500 to-indigo-700">@deckNewCards</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700"><Translate Text="Cards para revisar:"></Translate></span>
                    <span class="badge bg-gradient-to-r from-green-500 to-green-700">@deckReviewCards</span>
                </div>
            </div>
        </div>
    }

    <div class="mt-4 flex gap-2 w-full max-w-xs">
        <ButtonPrimary OnClick="ShowModal" Class="flex-1" Disabled="selectedDeckId == 0">
            <p class="text-white font-medium">🚀 <Translate Text="Iniciar revisão"></Translate></p>
        </ButtonPrimary>
        
        <button @onclick="NavigateToDeck" 
                disabled="@(selectedDeckId == 0)"
                class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200">
            <p class="text-white font-medium">📋 <Translate Text="Navegar deck"></Translate></p>
        </button>
    </div>
</div>
    
@if (showModal)
{
    <div class="modal-backdrop-custom" @onclick="HideModal"></div>
    <div class="modal fade show modal-animate" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h5 class="modal-title"><Translate Text="Escolha sua sessão de treino"></Translate></h5>
                </div>
                <div class="modal-body flex justify-center">
                    <div class="d-flex flex-column gap-2 mt-lg-1" style="max-width: 250px;">
                        <button class="btn btn-primary py-2 px-6 rounded-lg font-bold text-white shadow-lg bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 transition-all duration-200" @onclick="() => StartSession(ReviewSessionMode.Quick)">
                            <p class="text-white font-medium">⚡ <Translate Text="Rápida(5 novos, 15 revisados)"></Translate></p>
                        </button>

                        <button class="btn btn-primary py-2 px-6 rounded-lg font-bold text-white shadow-lg bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 transition-all duration-200" @onclick="() => StartSession(ReviewSessionMode.Regular)">
                            <p class="text-white font-medium">📘 <Translate Text="Normal (10 novos, 30 revisados)"></Translate></p>
                        </button>

                        <button class="btn btn-primary py-2 px-6 rounded-lg font-bold text-white shadow-lg bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 transition-all duration-200" @onclick="() => StartSession(ReviewSessionMode.Grind)">
                            <p class="text-white font-medium">💪 <Translate Text="Foco (20 novos, 60 revisados)"></Translate></p>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool showModal = false;
    private int userExp;
    private int selectedDeckId = 0;
    private DeckTable? selectedDeck = null;
    private int deckNewCards = 0;
    private int deckReviewCards = 0;

    private void ShowModal()
    {
        showModal = true;
    }

    private void HideModal()
    {
        showModal = false;
    }

    private async void StartSession(ReviewSessionMode mode)
    {
        if (selectedDeckId == 0)
            return;

        Navigation.NavigateTo($"{Routes.CardsReview}?mode={mode}&deckId={selectedDeckId}");
        HideModal();
    }

    private void NavigateToDeck()
    {
        if (selectedDeckId == 0)
            return;

        Navigation.NavigateTo($"{Routes.DecksView}?deckId={selectedDeckId}");
    }

    protected override async Task OnInitializedAsync()
    {
        userExp = await DatabaseService.GetUserExpAsync();
    }

    private async Task OnDeckChanged(int deckId)
    {
        selectedDeckId = deckId;

        if (deckId > 0)
        {
            selectedDeck = await DatabaseService.GetDeckByIdAsync(deckId);

            await base.OnDeckChanged(deckId);

            // Fetch card counts for the selected deck
            var (newCards, reviewCards) = await DatabaseService.GetDeckCardCountsAsync(deckId);
            deckNewCards = newCards;
            deckReviewCards = reviewCards;
        }
        else
        {
            selectedDeck = null;
            deckNewCards = 0;
            deckReviewCards = 0;
        }
        
        StateHasChanged();
    }
}