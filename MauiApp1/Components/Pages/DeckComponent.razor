@using Business.Model
@using Infrastructure.Data.Model
@inject MauiApp1.Services.DatabaseService DatabaseService
@inherits SmartComponent

<div class="deck-container">
    <h1 class="text-3xl font-bold mb-8 text-center text-indigo-700">@deck?.Name</h1>
    <p class="text-center text-gray-600 mb-4">@deck?.Description</p>

    <div class="mb-6 flex justify-center">
        <input type="text" class="search-input px-4 py-2 rounded-lg border border-gray-300 w-full max-w-md"
               placeholder="Search cards..." @bind="searchTerm" @bind:event="oninput" />
    </div>

    <div class="card-gallery grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        @if (orderedCards.Any())
        {
            @foreach (var card in orderedCards)
            {
                <MauiApp1.Components.User.CardSummary
                    Card="card"
                    OnDelete="() => ConfirmDeleteCard(card.CardId)"
                    OnEditConfirm="(def) => ConfirmEditCard(card.CardId, def)" />
            }
        }
        else
        {
            <p class="text-center text-gray-500 col-span-full">No cards found.</p>
        }
    </div>
</div>

@if (showDeleteConfirm)
{
    <div class="modal-backdrop-custom"></div>
    <div class="modal fade show modal-animate" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h5 class="modal-title text-red-600">Confirmar exclusão</h5>
                    <button type="button" class="close" @onclick="CancelDelete">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir este cartão?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" @onclick="DeleteCardConfirmed">Excluir</button>
                    <button class="btn btn-secondary" @onclick="CancelDelete">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int DeckId { get; set; }

    private Infrastructure.Data.Model.DeckTable? deck;
    private ICollection<SrsCard> allCards = new List<SrsCard>();
    private string searchTerm = "";

    // For deletion
    private SrsCard? cardToDelete;
    private bool showDeleteConfirm = false;

    protected override async Task OnInitializedAsync()
    {
        deck = await DatabaseService.GetFirstDeckAsync();

        if (deck != null)
        {
            allCards = await DatabaseService.QuerySrsCardsAsync(deck.Id);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (DeckId > 0)
        {
            deck = await DatabaseService.GetDeckByIdAsync(DeckId);

            if (deck != null)
            {
                allCards = await DatabaseService.QuerySrsCardsAsync(deck.Id);
            }
        }
    }

    private IEnumerable<SrsCard> orderedCards =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? allCards
            : allCards.Where(card =>
                card.SentencesInNativeLanguage.Any(s => s.Text.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                card.SentencesInTargetLanguage.Any(s => s.Text.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                card.Tags.Any(t => t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            ).OrderByDescending(c => c.Repetitions);

    // Deletion logic
    private void PromptDelete(SrsCard card)
    {
        cardToDelete = card;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        cardToDelete = null;
        showDeleteConfirm = false;
    }

    private async Task ConfirmDeleteCard(int cardId)
    {
        var confirmed = await PromptConfirm("Tem certeza que deseja excluir este cartão?");
        if (confirmed)
        {
            // Lógica para excluir o cartão
            // Exemplo: await DatabaseService.DeleteCardAsync(cardId);
            StateHasChanged();
        }
    }

    private async Task DeleteCardConfirmed()
    {
        if (cardToDelete != null && deck != null)
        {
            // Find CardTable Id by matching sentence and tags
            var cardTable = deck.Cards.FirstOrDefault(c =>
                c.Meaning.Sentences.Any(s => s.Text == cardToDelete.NativeSample.Text) &&
                c.Meaning.Sentences.Any(s => s.Text == cardToDelete.TargetSample.Text)
            );
            if (cardTable != null)
            {
                var success = await DatabaseService.DeleteCardAsync(cardTable.Id);
                if (success)
                {
                    allCards.Remove(cardToDelete);
                    StateHasChanged();
                }
            }
        }
        CancelDelete();
    }

    private async Task ConfirmEditCard(int cardId, CardDefinition updatedDefinition)
    {
        var success = await DatabaseService.UpdateCardAsync(cardId, updatedDefinition);
        if (success)
        {
            // Optionally refresh deck/cards
            StateHasChanged();
        }
    }
}

<style>
    .deck-container {
        padding: 40px;
        background-color: #f7f9fc;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        max-width: 1200px;
        margin: auto;
    }
    .search-input {
        font-size: 1rem;
    }
    .card-gallery {
        margin-top: 20px;
    }
</style>