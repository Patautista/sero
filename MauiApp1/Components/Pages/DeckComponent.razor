@using Business.Model
@using CommunityToolkit.Maui.Storage
@using Infrastructure.Data.Model
@inject MauiApp1.Services.DatabaseService DatabaseService
@inject IJSRuntime JS
@inherits SmartComponent

<div class="deck-container">
    <h1 class="text-3xl font-bold mb-4 text-center text-indigo-700">@deck?.Name</h1>
    <p class="text-center text-gray-600 mb-6">@deck?.Description</p>

    <div class="flex gap-2 mb-6 justify-center">
        <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                @onclick="ShowCreateCardModal">
            <i class="fa fa-plus"></i> Adicionar card
        </button>
        <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                @onclick="ExportDeck">
            <i class="fa fa-file"></i> Exportar
        </button>
    </div>

    <div class="mb-6 flex justify-center">
        <input type="text" class="search-input px-4 py-2 rounded-lg border border-gray-300 w-full max-w-md"
               placeholder="Search cards..." @bind="searchTerm" @bind:event="oninput" />
    </div>

    <MauiApp1.Components.LoadingSpinner IsLoading="@isLoading">
        <div class="card-gallery grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            @if (filteredCards.Any())
            {
                @foreach (var card in filteredCards)
                {
                    <MauiApp1.Components.User.CardSummary
                        Card="card"
                        OnDelete="() => PromptDelete(card)"
                        OnEditConfirm="(def) => ConfirmEditCard(card.CardId, def)" />
                }
            }
            else
            {
                <p class="text-center text-gray-500 col-span-full">No cards found.</p>
            }
        </div>
    </MauiApp1.Components.LoadingSpinner>
</div>

@if (showDeleteConfirm)
{
    <div class="modal-backdrop-custom"></div>
    <div class="modal fade show modal-animate" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h5 class="modal-title text-red-600"><Translate Text="Confirmar exclusão"></Translate></h5>
                    <button type="button" class="close" @onclick="CancelDelete">&times;</button>
                </div>
                <div class="modal-body">
                    <p><Translate Text="Tem certeza que deseja excluir este cartão?"></Translate></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" @onclick="DeleteCardConfirmed">Excluir</button>
                    <button class="btn btn-secondary" @onclick="CancelDelete">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showCreateCardModal)
{
    <div class="modal-backdrop-custom" @onclick="HideCreateCardModal"></div>
    <div class="modal fade show modal-animate" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h5 class="modal-title">Criar Novo Cartão</h5>
                    <button type="button" class="close" @onclick="HideCreateCardModal">&times;</button>
                </div>
                <div class="modal-body">
                    <MauiApp1.Components.Pages.CreateCard SelectedDeckId="DeckId" OnCardCreated="OnCardCreated" />
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(exportMessage))
{
    <div class="fixed bottom-4 right-4 bg-indigo-600 text-white px-4 py-2 rounded shadow-lg z-50">
        @exportMessage
    </div>
}

@code {
    [Parameter]
    public int DeckId { get; set; }

    private Infrastructure.Data.Model.DeckTable? deck;
    private ICollection<SrsCard> allCards = new List<SrsCard>();
    private string searchTerm = "";
    private bool showCreateCardModal = false;
    private string exportMessage = "";
    private bool isLoading = true;

    // For deletion
    private SrsCard? cardToDelete;
    private bool showDeleteConfirm = false;

    protected override async Task OnParametersSetAsync()
    {
        if (DeckId > 0)
        {
            deck = await DatabaseService.GetOnlyDeckById(DeckId);
        }
        else
        {
            deck = await DatabaseService.GetFirstDeckAsync();
            DeckId = deck.Id;
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isLoading = true;
            if (deck != null && isLoading)
            {
                allCards = await DatabaseService.QuerySrsCardsAsync(deck.Id);
            }
            isLoading = false;
            StateHasChanged();
        }
    }

    private IEnumerable<SrsCard> filteredCards =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? allCards
            : allCards.Where(card =>
                card.SentencesInNativeLanguage.Any(s => s.Text.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                card.SentencesInTargetLanguage.Any(s => s.Text.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                card.Tags.Any(t => t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            ).OrderBy(c => c.NextReview);

    // Deletion logic
    private void PromptDelete(SrsCard card)
    {
        cardToDelete = card;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        cardToDelete = null;
        showDeleteConfirm = false;
    }

    private async Task ConfirmDeleteCard(int cardId)
    {
        var confirmed = await PromptConfirm(Translate("Tem certeza que deseja excluir este cartão?"));
        if (confirmed)
        {
            // Lógica para excluir o cartão
            // Exemplo: await DatabaseService.DeleteCardAsync(cardId);
            StateHasChanged();
        }
    }

    private async Task DeleteCardConfirmed()
    {
        if (cardToDelete != null && deck != null)
        {

            var success = await DatabaseService.DeleteCardAsync(cardToDelete.CardId);
            if (success)
            {
                allCards.Remove(cardToDelete);
                StateHasChanged();
            }
        }
        CancelDelete();
    }

    private async Task ConfirmEditCard(int cardId, CardDefinition updatedDefinition)
    {
        var success = await DatabaseService.UpdateCardAsync(cardId, updatedDefinition);
        if (success)
        {
            // Optionally refresh deck/cards
            StateHasChanged();
        }
    }

    private void ShowCreateCardModal()
    {
        showCreateCardModal = true;
    }

    private void HideCreateCardModal()
    {
        showCreateCardModal = false;
    }

    private async Task ExportDeck()
    {
        exportMessage = "";
        deck = await DatabaseService.GetDeckByIdAsync(DeckId);
        if (deck == null || deck.Cards == null || !deck.Cards.Any())
        {
            exportMessage = "Deck vazio ou não encontrado.";
            StateHasChanged();
            return;
        }

        // Create default filename
        var fileName = $"{deck.Name}.apkg";

        try
        {
            // Let user choose save location
            var result = await FileSaver.Default.SaveAsync(fileName, Stream.Null);
            if (!result.IsSuccessful)
            {
                exportMessage = "Operação cancelada pelo usuário.";
                return;
            }

            // Use AnkiHelper to export the deck to the chosen location
            var ankiHelper = new Infrastructure.Parsing.AnkiHelper();
            await ankiHelper.ExportApkg(deck, result.FilePath);

            exportMessage = $"Deck exportado para: {result.FilePath}";
        }
        catch (Exception ex)
        {
            exportMessage = $"Erro ao exportar: {ex.Message}";
        }
        
        StateHasChanged();
    }

    private void OnCardCreated()
    {
        showCreateCardModal = false;
        StateHasChanged();
    }
}

<style>
    .deck-container {
        padding: 40px;
        background-color: #f7f9fc;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        max-width: 1200px;
        margin: auto;
    }
    .search-input {
        font-size: 1rem;
    }
    .card-gallery {
        margin-top: 20px;
    }
}
</style>