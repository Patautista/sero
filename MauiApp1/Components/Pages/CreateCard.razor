@page "/create-card"
@page "/create-card/{SharedText}"
@page "/create-card/{SharedText}/{Translation}"
@using System.Globalization
@using Business.Interfaces
@using Business.Model
@using Infrastructure.Data.Model
@using MauiApp1.Services
@using MauiApp1.Components.Shared
@inject IJSRuntime JS
@inject ISettingsService SettingsService
@inject ApiService ApiService
@inject MauiApp1.Services.DatabaseService DatabaseService
@inject NavigationManager Navigation
@inject LanguageDetectionService LanguageDetector
@inherits SmartComponent

<div class="card-creation-container p-6 bg-white rounded-lg shadow-lg max-w-2xl mx-auto mb-4">
    <h2 class="text-2xl font-bold mb-6 text-indigo-700"><Translate Text="Criar Novo Cartão"></Translate></h2>

    <!-- Deck Selection -->
    @if (!string.IsNullOrWhiteSpace(SharedText))
    {
        <div class="mb-4">
        <MauiApp1.Components.Shared.DeckPicker SelectedDeckIdChanged="OnDeckChanged" />
        @if (showValidation && SelectedDeckId == 0)
        {
            <span class="text-red-500 text-xs">Por favor, selecione um deck.</span>
        }
    </div>
    }

    <!-- Idioma primário -->
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2"><Translate Text="Idioma Primário"></Translate></label>
        <LoadingText IsLoading="@(primaryLanguage == LanguageDetected.Undecided)" Lines="1">
            <div class="flex items-center space-x-4">
                <span @onclick="SetTargetAsPrimary"
                      class="cursor-pointer px-3 py-1 rounded-lg transition
                            @(primaryLanguage == LanguageDetected.Target ? "bg-indigo-600 text-white font-semibold shadow" : "bg-gray-100 text-gray-700")">
                    @TargetLanguage?.DisplayName
                </span>
                <span @onclick="SetNativeAsPrimary"
                      class="cursor-pointer px-3 py-1 rounded-lg transition
                            @(primaryLanguage == LanguageDetected.Native ? "bg-indigo-600 text-white font-semibold shadow" : "bg-gray-100 text-gray-700")">
                    @Nativelanguage?.DisplayName
                </span>
            </div>
        </LoadingText>
        @if (!string.IsNullOrWhiteSpace(languageDetectionMessage))
        {
            <div class="mt-2 text-sm text-indigo-600">
                ℹ️ @languageDetectionMessage
            </div>
        }
    </div>

    <!-- Frase -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Frase em @(primaryLanguage == LanguageDetected.Target ? TargetLanguage?.DisplayName : Nativelanguage?.DisplayName)
        </label>
        <AutoResizeTextArea Value="@primarySentence"
                           ValueChanged="@((string val) => { primarySentence = val; StateHasChanged(); })"
                           Id="primarySentenceArea"
                           CssClass="@GetPrimarySentenceCssClass()"
                           Placeholder="Insira a frase"
                           MinRows="1"
                           MaxLength="80" />
        <div class="flex justify-between items-center mt-1">
            @if (showValidation && string.IsNullOrWhiteSpace(primarySentence))
            {
                <span class="text-red-500 text-xs">Campo obrigatório.</span>
            }
            else
            {
                <span></span>
            }
            <span class="text-xs text-gray-500">@primarySentence.Length/80</span>
        </div>
    </div>

    <!-- Translation Button -->
    @if (IsApiLive)
    {
        <div class="flex justify-center my-3">
            <button @onclick="TranslateAutomatically"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2"
                    disabled="@isTranslating">
                <i class='fa fa-language text-lg'></i>
                <span><Translate Text="Traduzir"></Translate></span>
            </button>
        </div>
    }

    <!-- Translation Input -->
    <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">@Translate("Tradução para") @(primaryLanguage == LanguageDetected.Target ? Nativelanguage?.DisplayName : TargetLanguage?.DisplayName)</label>
        <LoadingText IsLoading="@isTranslating" Lines="2">
            <AutoResizeTextArea Value="@translatedSentence"
                   ValueChanged="@((string val) => { translatedSentence = val; StateHasChanged(); })"
                   Id="translatedSentenceArea"
                   CssClass="@GetTranslatedSentenceCssClass()"
                   Placeholder="@Translate("Tradução")"
                   MinRows="1"
                   MaxLength="80"
                   Disabled="@isTranslating" />
        </LoadingText>
        <div class="flex justify-between items-center mt-1">
            @if (showValidation && string.IsNullOrWhiteSpace(translatedSentence))
            {
                <span class="text-red-500 text-xs">Campo obrigatório.</span>
            }
            else
            {
                <span></span>
            }
            <span class="text-xs text-gray-500">@translatedSentence.Length/80</span>
        </div>
    </div>

    <!-- Nível de dificuldade -->
    <!-- Tags -->
    <div class="mt-4 relative">
        <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>

        <!-- Input de pesquisa -->
        <input @bind-value="tagSearch"
               @bind-value:event="oninput"
               placeholder="Digite para buscar tags..."
               class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />

        <!-- Dropdown com resultados filtrados -->
        @if (showTagDropdown && filteredTags.Any())
        {
            <ul class="absolute z-10 bg-white border rounded-lg shadow mt-1 max-h-40 overflow-auto w-full">
                @foreach (var tag in filteredTags)
                {
                    <li class="px-3 py-2 hover:bg-indigo-100 cursor-pointer"
                        @onclick="() => SelectTag(tag)">
                        @tag.Name
                    </li>
                }
            </ul>
        }

        <!-- Tags selecionadas -->
        @if (selectedTags.Any())
        {
            <div class="flex flex-wrap gap-2 mt-2">
                @foreach (var tag in selectedTags)
                {
                    <span class="flex items-center px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm">
                        @tag.Name
                        <button type="button"
                                class="ml-1 text-red-600 hover:text-red-800"
                                @onclick="() => RemoveTag(tag)">
                            ✕
                        </button>
                    </span>
                }
            </div>
        }
    </div>

    <div class="mt-6 flex gap-2">
        <button @onclick="TrySaveCard"
                class="w-1/2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                disabled="@(!CanSave)">
            <Translate Text="Salvar Cartão"></Translate>
        </button>
    </div>
</div>

@code {
    [Parameter]
    public int SelectedDeckId { get; set; }

    [Parameter]
    public EventCallback OnCardCreated { get; set; }

    [Parameter]
    public string? SharedText { get; set; }

    [Parameter]
    public string? Translation { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "redirect")]
    public string? RedirectURL { get; set; }

    private CardDefinition card = new()
    {
        Tags = new List<Tag>()
    };

    private enum LanguageDetected { Native, Target, Undecided }

    private LanguageDetected primaryLanguage = LanguageDetected.Undecided;
    private string primarySentence = "";
    private string translatedSentence = "";
    private string newTag = "";
    private bool showValidation = false;
    private bool isTranslating = false;
    private ICollection<Tag> allTags = new List<Tag>();
    private List<Tag> filteredTags = new();
    private HashSet<Tag> selectedTags = new();
    private string languageDetectionMessage = "";

    private string _tagSearch = "";
    private string tagSearch
    {
        get => _tagSearch;
        set
        {
            _tagSearch = value;
            FilterTags(_tagSearch);
        }
    }

    private bool showTagDropdown = false;

    protected async override Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        allTags = await DatabaseService.GetTagsAsync();

        // If SharedText is provided via URL parameter, use it
        if (!string.IsNullOrWhiteSpace(SharedText))
        {
            primarySentence = Uri.UnescapeDataString(SharedText);
            DetectAndSetPrimaryLanguage(primarySentence);
            
            // If Translation is provided, auto-fill it
            if (!string.IsNullOrWhiteSpace(Translation))
            {
                translatedSentence = Uri.UnescapeDataString(Translation);
            }
            
            StateHasChanged();
        }
        else
        {
            primaryLanguage = LanguageDetected.Target;
        }

        // If no deck is selected, try to get the first available deck
        if (SelectedDeckId == 0)
        {
            var decks = await DatabaseService.GetAllDecksAsync();
            if (decks.Any())
            {
                SelectedDeckId = decks.First().Id;
            }
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (primaryLanguage == LanguageDetected.Undecided && !string.IsNullOrWhiteSpace(primarySentence))
        {
            DetectAndSetPrimaryLanguage(primarySentence);
        }
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Handle SharedText parameter changes
        if (!string.IsNullOrWhiteSpace(SharedText))
        {
            primarySentence = Uri.UnescapeDataString(SharedText);

            // Detect language and set primary language automatically
            DetectAndSetPrimaryLanguage(primarySentence);
            
            // If Translation is provided, auto-fill it
            if (!string.IsNullOrWhiteSpace(Translation))
            {
                translatedSentence = Uri.UnescapeDataString(Translation);
            }
        }
    }

    private async Task DetectAndSetPrimaryLanguage(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return;

        primaryLanguage = LanguageDetected.Undecided;
        languageDetectionMessage = "Detectando idioma...";
        StateHasChanged();

        // Simulate async detection if needed, or wrap synchronous call
        await Task.Run(() =>
        {
            var detectedCode = LanguageDetector.DetectLanguageCode(text);

            if (detectedCode == null)
            {
                languageDetectionMessage = "Não foi possível detectar o idioma automaticamente.";
                primaryLanguage = LanguageDetected.Target; // Default fallback
                return;
            }

            // Check if detected language matches target language
            if (detectedCode == TargetLanguageCode)
            {
                primaryLanguage = LanguageDetected.Target;
                languageDetectionMessage = $"Idioma detectado: {TargetLanguage?.DisplayName} (idioma de estudo)";
            }
            // Check if detected language matches native language
            else if (detectedCode == NativeLanguageCode)
            {
                primaryLanguage = LanguageDetected.Native;
                languageDetectionMessage = $"Idioma detectado: {Nativelanguage?.DisplayName} (idioma nativo)";
            }
            else
            {
                // Detected a different language
                var detectedCulture = new CultureInfo(detectedCode);
                languageDetectionMessage = $"Idioma detectado: {detectedCulture.DisplayName}. Por favor, verifique a seleção.";
                primaryLanguage = LanguageDetected.Target; // Default fallback
            }
        });

        StateHasChanged();
    }

    private void SetTargetAsPrimary()
    {
        primaryLanguage = LanguageDetected.Target;
        languageDetectionMessage = ""; // Clear detection message when manually changed
    }

    private void SetNativeAsPrimary()
    {
        primaryLanguage = LanguageDetected.Native;
        languageDetectionMessage = ""; // Clear detection message when manually changed
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(newTag))
        {
            card.Tags.Add(new Tag { Name = newTag.ToLower() });
            newTag = "";
        }
    }
    private void SelectTag(Tag tag)
    {
        selectedTags.Add(tag);
        tagSearch = "";
        filteredTags.Clear();
        showTagDropdown = false;
    }
    private void FilterTags(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
        {
            filteredTags = new();
            showTagDropdown = false;
        }
        else
        {
            filteredTags = allTags
                .Where(t => t.Name.Contains(input, StringComparison.OrdinalIgnoreCase)
                            && !selectedTags.Contains(t))
                .Take(10)
                .ToList();

            showTagDropdown = filteredTags.Any();
        }
    }

    private void RemoveTag(Tag tag)
    {
        selectedTags.Remove(tag);
    }

    private async Task TranslateAutomatically()
    {
        if (string.IsNullOrWhiteSpace(primarySentence) || Nativelanguage == null || TargetLanguage == null)
            return;

        isTranslating = true;
        StateHasChanged();

        try
        {
            string sourceLang, targetLang;
            if (primaryLanguage == LanguageDetected.Target)
            {
                sourceLang = TargetLanguage.TwoLetterISOLanguageName;
                targetLang = Nativelanguage.TwoLetterISOLanguageName;
            }
            else
            {
                sourceLang = Nativelanguage.TwoLetterISOLanguageName;
                targetLang = TargetLanguage.TwoLetterISOLanguageName;
            }

            var result = await ApiService.GetTranslationAsync(primarySentence, sourceLang, targetLang);
            translatedSentence = result;
            StateHasChanged();
        }
        finally
        {   
            isTranslating = false;
            StateHasChanged();
        }
    }

    private async Task GenerateAudioAutomatically()
    {
        var sentence = primaryLanguage == LanguageDetected.Target ? primarySentence : translatedSentence;

        await PlayVoiceClip(sentence, TargetLanguageCode);
    }

    private bool CanSave =>
        !string.IsNullOrWhiteSpace(primarySentence) &&
        !string.IsNullOrWhiteSpace(translatedSentence) &&
        SelectedDeckId != 0;

    private async Task TrySaveCard()
    {
        showValidation = true;

        if (!CanSave)
            return;

        var cardDefinition = new CardDefinition
        {
            NativeSentence = primaryLanguage == LanguageDetected.Native ? primarySentence : translatedSentence,
            TargetSentence = primaryLanguage == LanguageDetected.Target ? primarySentence : translatedSentence,
            NativeLanguageCode = NativeLanguageCode,
            TargetLanguageCode = TargetLanguageCode,
            DifficultyLevel = card.DifficultyLevel,
            Tags = selectedTags
        };

        await DatabaseService.CreateCard(cardDefinition, SelectedDeckId);

        // Invoke callback after card creation
        if (OnCardCreated.HasDelegate)
        {
            await OnCardCreated.InvokeAsync();
        }
        else if (!string.IsNullOrWhiteSpace(RedirectURL))
        {
            // Use custom redirect URL if provided
            Navigation.NavigateTo(RedirectURL);
        }
        else
        {
            Navigation.NavigateTo($"{Routes.DecksView}");
        }
    }

    private void ToggleTag(Tag tag, bool isChecked)
    {
        if (isChecked) selectedTags.Add(tag);
        else selectedTags.Remove(tag);
    }

    protected override async Task OnDeckChanged(int deckId)
    {
        SelectedDeckId = deckId;

        await base.OnDeckChanged(deckId);
        this.OnParametersSet();
    }

    private string GetPrimarySentenceCssClass()
    {
        return $"w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500{(showValidation && string.IsNullOrWhiteSpace(primarySentence) ? " border-red-500" : "")}";
    }

    private string GetTranslatedSentenceCssClass()
    {
        return $"w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500{(showValidation && string.IsNullOrWhiteSpace(translatedSentence) ? " border-red-500" : "")}";
    }
}