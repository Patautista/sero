@page "/create-card"
@using System.Globalization
@using Business.Model
@using Infrastructure.Data.Model
@inject IJSRuntime JS
@inject ISettingsService SettingsService
@inject ApiService ApiService
@inject MauiApp1.Services.DatabaseService DatabaseService
@inherits SmartComponent

<div class="card-creation-container p-6 bg-white rounded-lg shadow-lg max-w-2xl mx-auto">
    <h2 class="text-2xl font-bold mb-6 text-indigo-700">Criar Novo Cartão</h2>

    <!-- Deck Selection -->
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Deck</label>
        <select @bind="selectedDeckId" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="">-- Escolha um deck --</option>
            @foreach (var deck in decks)
            {
                <option value="@deck.Id">@deck.Name</option>
            }
        </select>
        @if (showValidation && selectedDeckId == 0)
        {
            <span class="text-red-500 text-xs">Selecione um deck.</span>
        }
    </div>

    <!-- Idioma primário -->
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Idioma Primário</label>
        <div class="flex items-center space-x-4">
            <span @onclick="SetTargetAsPrimary"
                  class="cursor-pointer px-3 py-1 rounded-lg transition
                        @(primaryLanguage == Language.Target ? "bg-indigo-600 text-white font-semibold shadow" : "bg-gray-100 text-gray-700")">
                @TargetLanguage?.DisplayName
            </span>
            <span @onclick="SetNativeAsPrimary"
                  class="cursor-pointer px-3 py-1 rounded-lg transition
                        @(primaryLanguage == Language.Native ? "bg-indigo-600 text-white font-semibold shadow" : "bg-gray-100 text-gray-700")">
                @Nativelanguage?.DisplayName
            </span>
        </div>
    </div>

    <!-- Frase -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Frase em @(primaryLanguage == Language.Target ? TargetLanguage?.DisplayName : Nativelanguage?.DisplayName)
        </label>
        <textarea @bind="primarySentence"
                  @oninput="@(e => AutoResize(e, "primarySentenceArea"))"
                  id="primarySentenceArea"
                  class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 @(showValidation && string.IsNullOrWhiteSpace(primarySentence) ? "border-red-500" : "")"
                  placeholder="Insira a frase"
                  rows="1"
                  style="overflow:hidden;resize:none"></textarea>
        @if (showValidation && string.IsNullOrWhiteSpace(primarySentence))
        {
            <span class="text-red-500 text-xs">Campo obrigatório.</span>
        }
    </div>

    <!-- Translation Input -->
    <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">@Translate("Tradução para") @(primaryLanguage == Language.Target ? Nativelanguage?.DisplayName : TargetLanguage?.DisplayName)</label>
        <div class="flex items-center gap-2">
            <textarea @bind="translatedSentence"
                      @oninput="@(e => AutoResize(e, "translatedSentenceArea"))"
                      id="translatedSentenceArea"
                      class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 @(showValidation && string.IsNullOrWhiteSpace(translatedSentence) ? "border-red-500" : "")"
                      placeholder="@Translate("Tradução")"
                      rows="1"
                      style="overflow:hidden;resize:none;height:@TranslatedTextAreaHeight"></textarea>
            @if (SettingsService.ApiConfig.Value != null)
            {
                <button @onclick="TranslateAutomatically"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    <Translate Text="Traduzir Automaticamente"></Translate>
                </button>
            }
        </div>
        @if (showValidation && string.IsNullOrWhiteSpace(translatedSentence))
        {
            <span class="text-red-500 text-xs">Campo obrigatório.</span>
        }
    </div>

    <!-- Nível de dificuldade -->
    <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Nível de Dificuldade</label>
        <select @bind="card.DifficultyLevel"
                class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            @foreach (var level in Enum.GetValues(typeof(DifficultyLevel)))
            {
                <option value="@level">@level</option>
            }
        </select>
    </div>

    <!-- Tags -->
    <div class="mt-4 relative">
        <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>

        <!-- Input de pesquisa -->
        <input @bind-value="tagSearch"
               @bind-value:event="oninput"
               placeholder="Digite para buscar tags..."
               class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />

        <!-- Dropdown com resultados filtrados -->
        @if (showTagDropdown && filteredTags.Any())
        {
            <ul class="absolute z-10 bg-white border rounded-lg shadow mt-1 max-h-40 overflow-auto w-full">
                @foreach (var tag in filteredTags)
                {
                    <li class="px-3 py-2 hover:bg-indigo-100 cursor-pointer"
                        @onclick="() => SelectTag(tag)">
                        @tag.Name
                    </li>
                }
            </ul>
        }

        <!-- Tags selecionadas -->
        @if (selectedTags.Any())
        {
            <div class="flex flex-wrap gap-2 mt-2">
                @foreach (var tag in selectedTags)
                {
                    <span class="flex items-center px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm">
                        @tag.Name
                        <button type="button"
                                class="ml-1 text-red-600 hover:text-red-800"
                                @onclick="() => RemoveTag(tag)">
                            ✕
                        </button>
                    </span>
                }
            </div>
        }
    </div>

    <div class="mt-6 flex gap-2">
        @if (SettingsService.ApiConfig.Value != null)
        {
            <ButtonPrimary Onclick="GenerateAudioAutomatically">
                <Translate Text="Gerar Áudio Automaticamente"></Translate>
            </ButtonPrimary>
        }
        <button @onclick="TrySaveCard"
                class="w-1/2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                disabled="@(!CanSave)">
            <Translate Text="Salvar Cartão"></Translate>
        </button>
    </div>
</div>

@code {
    private CardDefinition card = new()
    {
        Tags = new List<Tag>()
    };

    private enum Language { Native, Target }

    private Language primaryLanguage = Language.Target;
    private string primarySentence = "";
    private string translatedSentence = "";
    private string newTag = "";
    private bool showValidation = false;
    private bool isTranslating = false;
    private ICollection<Tag> allTags = new List<Tag>();
    private List<Tag> filteredTags = new();
    private HashSet<Tag> selectedTags = new();
    private List<DeckTable> decks = new();
    private int selectedDeckId = 0;

    private string _tagSearch = "";
    private string tagSearch
    {
        get => _tagSearch;
        set
        {
            _tagSearch = value;
            FilterTags(_tagSearch);
        }
    }

    private bool showTagDropdown = false;

    protected async override Task OnInitializedAsync()
    {
        allTags = await DatabaseService.GetTagsAsync();
        decks = await DatabaseService.GetAllDecksAsync();
    }

    private void SetTargetAsPrimary()
    {
        primaryLanguage = Language.Target;
    }

    private void SetNativeAsPrimary()
    {
        primaryLanguage = Language.Native;
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(newTag))
        {
            card.Tags.Add(new Tag { Name = newTag.ToLower() });
            newTag = "";
        }
    }
    private void SelectTag(Tag tag)
    {
        selectedTags.Add(tag);
        tagSearch = "";
        filteredTags.Clear();
        showTagDropdown = false;
    }
    private void FilterTags(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
        {
            filteredTags = new();
            showTagDropdown = false;
        }
        else
        {
            filteredTags = allTags
                .Where(t => t.Name.Contains(input, StringComparison.OrdinalIgnoreCase)
                            && !selectedTags.Contains(t))
                .Take(10)
                .ToList();

            showTagDropdown = filteredTags.Any();
        }
    }

    private void RemoveTag(Tag tag)
    {
        selectedTags.Remove(tag);
    }

    private async Task TranslateAutomatically()
    {
        if (string.IsNullOrWhiteSpace(primarySentence) || Nativelanguage == null || TargetLanguage == null)
            return;

        isTranslating = true;
        StateHasChanged();

        try
        {
            string sourceLang, targetLang;
            if (primaryLanguage == Language.Target)
            {
                sourceLang = TargetLanguage.TwoLetterISOLanguageName;
                targetLang = Nativelanguage.TwoLetterISOLanguageName;
            }
            else
            {
                sourceLang = Nativelanguage.TwoLetterISOLanguageName;
                targetLang = TargetLanguage.TwoLetterISOLanguageName;
            }

            var result = await ApiService.GetTranslationAsync(primarySentence, sourceLang, targetLang);
            translatedSentence = result;
            StateHasChanged();
        }
        finally
        {   
            isTranslating = false;
            StateHasChanged();
        }
    }

    private async Task GenerateAudioAutomatically()
    {
        var lang = primaryLanguage == Language.Target ? TargetLanguage : Nativelanguage;

        await PlayVoiceClip(primarySentence, lang.TwoLetterISOLanguageName);
    }

    private bool CanSave =>
        !string.IsNullOrWhiteSpace(primarySentence) &&
        !string.IsNullOrWhiteSpace(translatedSentence) &&
        selectedDeckId != 0;

    private async Task TrySaveCard()
    {
        showValidation = true;

        if (!CanSave)
            return;

        var cardDefinition = new CardDefinition
        {
            NativeSentence = primaryLanguage == Language.Native ? primarySentence : translatedSentence,
            TargetSentence = primaryLanguage == Language.Target ? primarySentence : translatedSentence,
            NativeLanguageCode = NativelanguageCode,
            TargetLanguageCode = TargetLanguageCode,
            DifficultyLevel = card.DifficultyLevel,
            Tags = selectedTags
        };

        await DatabaseService.CreateCard(cardDefinition, selectedDeckId);
    }
    private async Task AutoResize(ChangeEventArgs e, string id)
    {
        await JS.InvokeVoidAsync("autoResizeTextArea", id);
    }

    private void ToggleTag(Tag tag, bool isChecked)
    {
        if (isChecked) selectedTags.Add(tag);
        else selectedTags.Remove(tag);
    }
    private string TranslatedTextAreaHeight
    {
        get
        {
            if (string.IsNullOrEmpty(translatedSentence))
                return "2.5em";
            var lines = translatedSentence.Split('\n').Length;
            int approxLines = lines + (int)Math.Ceiling(translatedSentence.Length / 60D);
            return $"{Math.Max(approxLines * 2.5, 2.5)}em".Replace(",", ".");
        }
    }
}

<script>
  window.autoResizeTextArea = (id) => {
    var el = document.getElementById(id);
    if (el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }
  }
</script>