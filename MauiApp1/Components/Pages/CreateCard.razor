@page "/create-card"
@using System.Globalization

@inject ISettingsService SettingsService
@inject ApiService ApiService

<div class="card-creation-container p-6 bg-white rounded-lg shadow-lg max-w-2xl mx-auto">
    <h2 class="text-2xl font-bold mb-6 text-indigo-700">Criar Novo Cartão</h2>

    <!-- Target Language Sentences -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Frases em @_targetLang.DisplayName</label>
        <div class="flex items-center gap-2">
            <input @bind="newTargetSentence"
                   class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                   placeholder="Insira a frase na língua alvo" />
            <button @onclick="AddTargetSentence"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                Adicionar
            </button>
        </div>
        @if (card.SentencesInTargetLanguage.Any())
        {
            <ul class="mt-2 space-y-1">
                @foreach (var sentence in card.SentencesInTargetLanguage)
                {
                    <li class="flex items-center gap-2">
                        <span>@sentence.Text</span>
                        @if (SettingsService.ApiKey.Value != null)
                        {
                            <button @onclick="() => GenerateAudio(sentence, false)"
                                    class="text-indigo-600 hover:text-indigo-800">
                                🔊
                            </button>
                        }
                    </li>
                }
            </ul>
        }
    </div>

    <div class="space-y-4">
        <!-- Native Language Sentences -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Frases em @_nativeLang.DisplayName</label>
            <div class="flex items-center gap-2">
                <input @bind="newNativeSentence"
                       class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                       placeholder="Insira a frase na língua nativa" />
                <button @onclick="AddNativeSentence"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Adicionar
                </button>
            </div>
            @if (card.SentencesInNativeLanguage.Any())
            {
                <ul class="mt-2 space-y-1">
                    @foreach (var sentence in card.SentencesInNativeLanguage)
                    {
                        <li class="flex items-center gap-2">
                            <span>@sentence.Text</span>
                            @if (SettingsService.ApiKey.Value != null)
                            {
                                <button @onclick="() => GenerateAudio(sentence, true)"
                                        class="text-indigo-600 hover:text-indigo-800">
                                    🔊
                                </button>
                            }
                        </li>
                    }
                </ul>
            }
        </div>

        <!-- Difficulty Level -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Nível de Dificuldade</label>
            <select @bind="card.DifficultyLevel"
                    class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                @foreach (var level in Enum.GetValues(typeof(DifficultyLevel)))
                {
                    <option value="@level">@level</option>
                }
            </select>
        </div>

        <!-- Tags -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
            <div class="flex items-center gap-2">
                <input @bind="newTag"
                       class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                       placeholder="Insira a tag" />
                <button @onclick="AddTag"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Adicionar Tag
                </button>
            </div>
            @if (card.Tags.Any())
            {
                <div class="flex flex-wrap gap-2 mt-2">
                    @foreach (var tag in card.Tags)
                    {
                        <span class="px-2 py-1 bg-gray-100 rounded-full text-sm">@tag.Name</span>
                    }
                </div>
            }
        </div>

        <div class="mt-6">
            <button @onclick="SaveCard"
                    class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Salvar Cartão
            </button>
        </div>
    </div>
</div>

@code {
    private Card card = new()
    {
        SentencesInNativeLanguage = new List<Sentence>(),
        SentencesInTargetLanguage = new List<Sentence>(),
        Tags = new List<Tag>()
    };

    private CultureInfo _nativeLang = null;
    private CultureInfo _targetLang = null;

    protected override void OnInitialized()
    {
        _nativeLang = SettingsService.StudyConfig.Value?.SelectedLanguage.Source;
        _targetLang = SettingsService.StudyConfig.Value?.SelectedLanguage.Target;
    }

    private string newNativeSentence = "";
    private string newTargetSentence = "";
    private string newTag = "";

    private void AddNativeSentence()
    {
        if (!string.IsNullOrWhiteSpace(newNativeSentence))
        {
            card.SentencesInNativeLanguage.Add(new Sentence { Text = newNativeSentence });
            newNativeSentence = "";
        }
    }

    private void AddTargetSentence()
    {
        if (!string.IsNullOrWhiteSpace(newTargetSentence))
        {
            card.SentencesInTargetLanguage.Add(new Sentence { Text = newTargetSentence });
            newTargetSentence = "";
        }
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(newTag))
        {
            card.Tags.Add(new Tag { Name = newTag.ToLower() });
            newTag = "";
        }
    }

    private async Task GenerateAudio(Sentence sentence, bool isNative)
    {
        try
        {

            var lang = isNative ? _nativeLang.Name : _targetLang.Name;

            var audioData = await ApiService.GetTTSAsync(sentence.Text, lang);
        }
        catch (Exception ex)
        {
            // Handle error (e.g., show notification)
            Console.WriteLine($"Error generating audio: {ex.Message}");
        }
    }

    private async Task SaveCard()
    {
        // Implement save logic here
        // You might want to inject a service to handle the saving
        await Task.CompletedTask;
    }
}