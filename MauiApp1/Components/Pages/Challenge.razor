@page "/anki"

@using System.Text
@using Business.ViewModel
@using Domain
@using Domain.Events
@using CommunityToolkit.Maui.Alerts;
@using MauiApp1.Components.User
@using Microsoft.AspNetCore.WebUtilities;

@inject NavigationManager Navigation
@inject SoundService SoundService
@using MauiApp1.Services
@attribute [StreamRendering(true)]

@inject DatabaseService Database

<PageTitle>Frases Anki</PageTitle>

@if (cards == null)
{
    <LoadingSpinner></LoadingSpinner>
}
else if (currentCard != null)
{
    <div class="anki-container">
        <div class="anki-top-section transition-all duration-300 ease-in-out" style="filter: blur(@(isInputFocused ? "2px" : "0")); transform: scale(@(isInputFocused ? "0.95" : "1"));">
            <!-- Indicadores superiores -->
            <div class="mb-3 flex columns-3 gap-4 justify-between items-center">
                <div>
                    <span class="badge bg-gradient-to-r from-indigo-500 to-indigo-700">Novos: @newCount</span>
                    <span class="badge bg-gradient-to-r from-green-500 to-green-700 text">Revisões: @reviewCount</span>
                </div>

                <!-- Level display -->
                @if (totalExp >= 0)
                {
                    var (level, expInto, expNeeded) = ExpCalculator.GetLevelProgress(totalExp);

                    <LevelIndicator ExpNeeded="expNeeded" ExpInto="expInto" Level="level"></LevelIndicator>
                }
            </div>
        </div>

        <div class="card p-4 mb-3" style="max-width: 600px; position: relative">
            <div class="card-content transition-all duration-300 ease-in-out" style="filter: blur(@(isInputFocused ? "2px" : "0")); transform: scale(@(isInputFocused ? "0.95" : "1"));">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h1 class="text-xl font-medium">Escreva em Italiano</h1>

                    <!-- Floating EXP badge -->
                    @if (_challengeState.ExpEarned.HasValue)
                    {
                        <div class="exp-badge">
                            +@_challengeState.ExpEarned EXP
                        </div>
                    }
                </div>

                <!-- Resposta para card novo -->
                @if (currentCard.State.Repetitions == 0)
                {
                    <div class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-3 rounded-lg shadow-md mb-4" role="alert">
                        <p class="mb-0 text-sm font-medium">
                            Novo card! Resposta: <strong class="font-semibold">@currentCard.Card.TargetSample.Text</strong>
                        </p>
                    </div>
                }
            </div>

            <!-- Prompt em língua nativa -->
            <p class="w-fit mb-5 mt-3 text-gray-950 animated-underline">@currentCard.Card.NativeSample.Text</p>
            <input class="w-full form-control mb-2 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" @bind="_challengeState.UserAnswer" placeholder="Resposta" @onfocus="() => isInputFocused = true" @onblur="() => isInputFocused = false" />

            <div class="card-buttons transition-all duration-300 ease-in-out">
                <div class="flex justify-between">
                    <div style="filter: blur(@(isInputFocused ? "2px" : "0")); transform: scale(@(isInputFocused ? "0.95" : "1"));">
                        <ButtonSecondary OnClick="SkipCard">Pular</ButtonSecondary>
                    </div>
                    <ButtonPrimary OnClick="CheckAnswer">Conferir</ButtonPrimary>
                </div>

                <AnswerValidationMessage ValidationMessage="@_challengeState.ValidationMessage"
                                         IsCorrect="@_challengeState.IsCorrect"
                                         AnswerTime="@_challengeState.AnswerTime" />

                @if (_challengeState.AnswerQuality != AnswerQuality.Perfect)
                {
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600 mb-2">Sua resposta estava correta?</p>
                        <button class="btn btn-sm btn-outline-success" @onclick="ForceCorrectAnswer">
                            Sim, aceitar como resposta correta
                        </button>
                    </div>
                }

                <NextCardCountdown Countdown="@_challengeState.Countdown" />
            </div>
        </div>
    </div>
}
else
{
    <div class="card p-4 mb-3 text-center" style="max-width: 600px;">
        <h3>🎉 Sessão concluída!</h3>
        <p>Você revisou todos os cards de hoje.</p>
        <ButtonPrimary OnClick="ReturnToReview">Retornar à tela de seleção</ButtonPrimary>
    </div>
}
@code {
    [Parameter] public ReviewSessionMode ReviewSessionMode { get; set; } = ReviewSessionMode.Regular;
    private ICollection<CardWithState> cards;
    private CardWithState currentCard;
    private class ChallengeState
    {
        public string UserAnswer;
        public string ValidationMessage;
        public bool IsCorrect;
        public AnswerQuality AnswerQuality = AnswerQuality.Perfect; // Estado para mostrar o botão de correção
        public int Countdown;
        public int? ExpEarned;
        public DateTime CardShownAt;
        public TimeSpan AnswerTime;
        public bool NextCardCalled = true;
    }
    private ChallengeState _challengeState = new();
    private int newCount;
    private int reviewCount;
    private int totalExp;
    private System.Timers.Timer countdownTimer;
    private bool isInputFocused = false;


    protected override async Task OnInitializedAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("mode", out var limitParam) && Enum.TryParse<ReviewSessionMode>(limitParam, out var mode))
        {
            ReviewSessionMode = mode;
        }

        totalExp = await Database.GetUserExpAsync();
        cards = await Database.GetDueCards(ReviewSessionMode, totalExp);

        // Calculate counters
        newCount = cards.Count(c => c.State.Repetitions == 0);
        reviewCount = cards.Count(c => c.State.Repetitions > 0);
        NextCard();
    }

    private async Task SkipCard()
    {
        var evt = new CardSkippedEvent(
            Guid.NewGuid(),
            currentCard.State.CardId
        );

        await Database.SaveCardSkippedAsync(evt);

        NextCard();
    }

    private void NextCard()
    {
        if (cards == null || !cards.Any())
        {
            currentCard = null;
            StateHasChanged();
            return;
        }

        // Stop timer
        countdownTimer?.Stop();
        _challengeState.Countdown = 0;

        // Pick random card
        var rnd = new Random();
        currentCard = cards.ElementAt(rnd.Next(cards.Count));

        // Remove it from the pool once shown
        cards.Remove(currentCard);

        _challengeState.UserAnswer = string.Empty;
        _challengeState.ValidationMessage = null;
        _challengeState.IsCorrect = false;
        _challengeState.AnswerQuality = AnswerQuality.Perfect;
        _challengeState.AnswerTime = TimeSpan.Zero;
        _challengeState.ExpEarned = null;

        _challengeState.CardShownAt = DateTime.UtcNow;
        StateHasChanged();
    }

    private async Task CheckAnswer()
    {
        if (string.IsNullOrWhiteSpace(_challengeState.UserAnswer) || _challengeState.Countdown > 0) return;

        // Calculate answer time
        _challengeState.AnswerTime = DateTime.UtcNow - _challengeState.CardShownAt;

        var possibleAnswers = currentCard.Card.SentencesInTargetLanguage.Select(c => c.Text).ToList();
        var evaluation = AnswerEvaluator.Evaluate(_challengeState.UserAnswer, possibleAnswers);

        _challengeState.IsCorrect = evaluation.Quality != AnswerQuality.Wrong;
        _challengeState.AnswerQuality = evaluation.Quality;

        if (_challengeState.IsCorrect)
        {
            _challengeState.ExpEarned = ExpCalculator.CalculateEarnedExp(currentCard.Card, currentCard.State.Repetitions);
            totalExp += _challengeState.ExpEarned.Value;
            await PlayVoice(evaluation.ClosestMatch, currentCard.Card.TargetSample.Language);
        }

        Srs.Review(currentCard.State, (int)evaluation.Quality);
        _challengeState.ValidationMessage = AnswerEvaluator.BuildFeedbackMessage(evaluation, _challengeState.UserAnswer);

        await Database.UpdateUserCardState(currentCard.State, _challengeState.ExpEarned ?? 0);

        var evt = new CardAnsweredEvent(
            Guid.NewGuid(),
            currentCard.State.CardId,
            (int)_challengeState.AnswerTime.TotalMilliseconds,
            Correct: _challengeState.IsCorrect
        );

        await Database.SaveCardAnsweredAsync(evt);

        StartCountdown(_challengeState.AnswerQuality == AnswerQuality.Perfect ? 3 : 7);

        // Update counters
        newCount = cards.Count(c => c.State.Repetitions == 0);
        reviewCount = cards.Count(c => c.State.Repetitions > 0);

        StateHasChanged();
    }

    private async Task PlayVoice(string text, string lang)
    {
        var toast = Toast.Make("Reproduzindo áudio.", CommunityToolkit.Maui.Core.ToastDuration.Short, 14);
        await toast.Show(CancellationToken.None);
        SoundService.PlayVoice(text, currentCard.Card.TargetSample.Language);
    }

    private async Task ForceCorrectAnswer()
    {
        // Add the user's answer as a new alternative sentence
        var newSentence = new Sentence
        {
            MeaningId = currentCard.Card.NativeSample.MeaningId,
            Text = _challengeState.UserAnswer,
            Language = currentCard.Card.TargetSample.Language
        };
        await Database.AddAlternativeSentence(newSentence);

        // Treat as a correct answer from now on
        if (!_challengeState.IsCorrect)
        {
            _challengeState.IsCorrect = true;
            _challengeState.ExpEarned = ExpCalculator.CalculateEarnedExp(currentCard.Card, currentCard.State.Repetitions);
            totalExp += _challengeState.ExpEarned.Value;

            // Review the card with a "correct" quality
            Srs.Review(currentCard.State, (int)AnswerQuality.Ok);
            await Database.UpdateUserCardState(currentCard.State, _challengeState.ExpEarned ?? 0);
        }
        _challengeState.ValidationMessage = "✅ Correto! Sua resposta foi adicionada como alternativa.";


        var evt = new CardAnsweredEvent(
            Guid.NewGuid(),
            currentCard.State.CardId,
            (int)_challengeState.AnswerTime.TotalMilliseconds,
            Correct: true
        );
        await Database.SaveCardAnsweredAsync(evt);

        // Hide correction option and start countdown for next card
        _challengeState.AnswerQuality = AnswerQuality.Perfect;
    }

    private void StartCountdown(int seconds)
    {
        _challengeState.Countdown = seconds;
        _challengeState.NextCardCalled = false;

        countdownTimer = new System.Timers.Timer(1000);
        countdownTimer.Elapsed += async (s, e) =>
        {
            _challengeState.Countdown--;
            await InvokeAsync(StateHasChanged);

            if (_challengeState.Countdown <= 0 && !_challengeState.NextCardCalled)
            {
                _challengeState.NextCardCalled = true;
                countdownTimer.Stop();
                countdownTimer.Dispose();
                countdownTimer = null;

                await InvokeAsync(NextCard);
            }
        };
        countdownTimer.Start();
    }

    private void RestartSession()
    {
        // reload everything fresh
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }
    private void ReturnToReview()
    {
        Navigation.NavigateTo(Routes.SessionSelect);
    }

}
