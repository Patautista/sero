@page "/decks"
@using Business.Interfaces
@using Business.Model
@using CommunityToolkit.Maui.Storage
@using Infrastructure.Data.Model
@inherits SmartComponent
@inject MauiApp1.Services.DatabaseService DatabaseService
@inject ISettingsService SettingsService
@inject IJSRuntime JS

<div class="card flex flex-col items-center mb-5 p-3">
    <div class="mb-4 w-full max-w-xs">
        <MauiApp1.Components.Shared.DeckPicker @bind-SelectedDeckId="selectedDeckId" />
    </div>
</div>

<div class="flex justify-center items-center min-h-[400px]">
    <LoadingSpinner IsLoading="isLoading">
        @if (selectedDeckId > 0)
        {
            <DeckComponent DeckId="selectedDeckId" @key="selectedDeckId" />
        }
        else
        {
            <div class="text-center text-gray-500 mt-8">Selecione um deck para visualizar.</div>
        }
    </LoadingSpinner>
</div>

@code {
    private int selectedDeckId = 0;
    private int previousDeckId = 0;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        isLoading = true;
        
        // Set the first deck as selected by default
        var decks = await DatabaseService.GetAllDecksAsync();
        if (decks != null && decks.Any())
        {
            selectedDeckId = decks.First().Id;
            previousDeckId = selectedDeckId;
        }
        
        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        // Detect deck changes and show loading spinner
        if (!firstRender && selectedDeckId != previousDeckId && selectedDeckId > 0)
        {
            isLoading = true;
            StateHasChanged();
            
            // Small delay to ensure the spinner is visible
            await Task.Delay(100);
            
            previousDeckId = selectedDeckId;
            isLoading = false;
            StateHasChanged();
        }
    }
}