@page "/decks"
@using Business.Interfaces
@using Business.Model
@using CommunityToolkit.Maui.Storage
@using Infrastructure.Data.Model
@using Microsoft.AspNetCore.WebUtilities
@inherits SmartComponent
@inject MauiApp1.Services.DatabaseService DatabaseService
@inject ISettingsService SettingsService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="flex justify-center items-center min-h-[400px]">
    <LoadingSpinner IsLoading="isLoading">
        @if (selectedDeckId > 0)
        {
            <DeckComponent DeckId="selectedDeckId" @key="selectedDeckId" />
        }
        else
        {
            <div class="text-center text-gray-500 mt-8">
                <p class="mb-4">Nenhum deck disponível.</p>
                <button class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                        @onclick="ShowCreateDeckModal">
                    <i class="fa fa-plus mr-2"></i>
                    <Translate Text="Criar Primeiro Deck"></Translate>
                </button>
            </div>
        }
    </LoadingSpinner>
</div>

@if (showCreateDeckModal)
{
    <div class="modal-backdrop-custom" @onclick="HideCreateDeckModal"></div>
    <div class="modal fade show modal-animate" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h5 class="modal-title"><Translate Text="Criar Novo Deck"></Translate></h5>
                    <button type="button" class="close" @onclick="HideCreateDeckModal">&times;</button>
                </div>
                <div class="modal-body">
                    <CreateDeck OnDeckCreated="OnDeckCreated" OnCancel="HideCreateDeckModal" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    private int selectedDeckId = 0;
    private int previousDeckId = 0;
    private bool isLoading = true;
    private bool showCreateDeckModal = false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        isLoading = true;
        
        // Check if deckId was passed as a query parameter
        var uri = new Uri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);
        
        if (queryParams.TryGetValue("deckId", out var deckIdValue) && int.TryParse(deckIdValue, out var deckId))
        {
            selectedDeckId = deckId;
            previousDeckId = selectedDeckId;
        }
        else
        {
            // Set the first deck as selected by default only if no deckId was provided
            var deck = await DatabaseService.GetLastUsedDeckAsync();
            if (deck != null)
            {
                selectedDeckId = deck.Id;
                previousDeckId = selectedDeckId;
            }
        }
        
        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        // Detect deck changes and show loading spinner
        if (!firstRender && selectedDeckId != previousDeckId && selectedDeckId > 0)
        {
            isLoading = true;
            StateHasChanged();
            
            // Small delay to ensure the spinner is visible
            await Task.Delay(100);
            
            previousDeckId = selectedDeckId;
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ShowCreateDeckModal()
    {
        showCreateDeckModal = true;
    }

    private void HideCreateDeckModal()
    {
        showCreateDeckModal = false;
    }

    private async Task OnDeckCreated(int newDeckId)
    {
        showCreateDeckModal = false;
        
        // Reload decks and select the newly created one
        if (newDeckId > 0)
        {
            selectedDeckId = newDeckId;
            previousDeckId = newDeckId;
        }
        
        StateHasChanged();
    }
}

<style>
    .modal-backdrop-custom {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }

    .modal {
        z-index: 1050;
    }

    .modal-animate {
        animation: slideIn 0.3s ease-out;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
    }

    .close:hover {
        color: #374151;
    }
</style>