@page "/anki"

@using System.Text
@using Business.ViewModel
@using Domain
@using Microsoft.AspNetCore.WebUtilities;

@inject NavigationManager Navigation
@using MauiApp1.Services
@attribute [StreamRendering(true)]

@inject DatabaseService Api

<PageTitle>Frases Anki</PageTitle>

@if (cards == null)
{
    <p><em>Carregando...</em></p>
}
else if (currentCard != null)
{
    <div class="mb-3">
        <span class="badge bg-success">Novos: @newCount</span>
        <span class="badge bg-info text-dark">Revisões: @reviewCount</span>
    </div>

    <div class="card p-4 mb-3" style="max-width: 600px; position: relative">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Traduza para o Italiano:</h5>

            <!-- Level display -->
            @if (totalExp >= 0)
            {
                var (level, expInto, expNeeded) = ExpCalculator.GetLevelProgress(totalExp);
                <div class="text-end">
                    <span class="badge bg-warning text-dark">Lv. @level</span>
                    <div class="progress" style="width: 120px; height: 10px; margin-top: 4px;">
                        <div class="progress-bar bg-success"
                             role="progressbar"
                             style="width:@((expInto * 100 / expNeeded))%"
                             aria-valuenow="@expInto"
                             aria-valuemin="0"
                             aria-valuemax="@expNeeded">
                        </div>
                    </div>
                </div>
            }

            <!-- Floating EXP badge -->
            @if (expEarned.HasValue)
            {
                <div class="exp-badge">
                    +@expEarned EXP
                </div>
            }
        </div>

        <p class="mb-3"><strong>@currentCard.Card.NativeSentence.Text</strong></p>

        @if (currentCard.Card.Tags != null && currentCard.Card.Tags.Any())
        {
            <p class="mb-3 text-muted">
                Tags: @string.Join(", ", currentCard.Card.Tags.Select(t => t.Name))
            </p>
        }

        @if (currentCard.State.Repetitions == 0)
        {
            <p class="alert alert-info">
                Novo card! Resposta: <strong>@currentCard.Card.TargetSentence.Text</strong>
            </p>
        }

        <input class="form-control mb-2" @bind="userAnswer" placeholder="Type your answer" />
        <button class="btn btn-primary mb-2" @onclick="CheckAnswer">Conferir</button>

        @if (validationMessage != null)
        {
            <p class="mt-2" style="color:@(isCorrect ? "green" : "red")">
                @validationMessage
                <br />
                <small>Tempo da resposta: @answerTime.TotalSeconds.ToString("0.00") s</small>
            </p>
        }

        @if (countdown > 0)
        {
            <p class="text-muted">Próxima frase em @countdown...</p>
        }

        <button class="btn btn-secondary mt-2" @onclick="NextCard">Próxima frase</button>

        <div style="margin-top: 5vh">
            <DictCcSearch></DictCcSearch>
            <ConjugationLookup></ConjugationLookup>
        </div>
    </div>
}
else
{
    <div class="card p-4 mb-3 text-center" style="max-width: 600px;">
        <h3>🎉 Sessão concluída!</h3>
        <p>Você revisou todos os cards de hoje.</p>
        <button class="btn btn-primary" @onclick="ReturnToReview">Retornar à tela de seleção</button>
    </div>
}
@code {
    [Parameter] public ReviewSessionMode ReviewSessionMode { get; set; } = ReviewSessionMode.Regular;
    private ICollection<CardWithState> cards;
    private CardWithState currentCard;
    private string userAnswer;
    private string validationMessage;
    private bool isCorrect;
    private int countdown;
    private int newCount;
    private int reviewCount;
    private int? expEarned;
    private int totalExp;
    private System.Timers.Timer countdownTimer;

    private DateTime cardShownAt;
    private TimeSpan answerTime;

    protected override async Task OnInitializedAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("mode", out var limitParam) && Enum.TryParse<ReviewSessionMode>(limitParam, out var mode))
        {
            ReviewSessionMode = mode;
        }

        totalExp = await Api.GetUserExpAsync();
        cards = await Api.GetDueCards(ReviewSessionMode, totalExp);

        // Calculate counters
        newCount = cards.Count(c => c.State.Repetitions == 0);
        reviewCount = cards.Count(c => c.State.Repetitions > 0);

        NextCard();
    }

    private void NextCard()
    {
        if (cards == null || !cards.Any())
        {
            currentCard = null; // nothing left → trigger completion screen
            StateHasChanged();
            return;
        }

        // Stop timer
        countdownTimer?.Stop();
        countdown = 0;

        // Pick random card
        var rnd = new Random();
        currentCard = cards.ElementAt(rnd.Next(cards.Count));

        // Remove it from the pool once shown
        cards.Remove(currentCard);

        userAnswer = string.Empty;
        validationMessage = null;
        isCorrect = false;
        answerTime = TimeSpan.Zero;
        expEarned = null;

        cardShownAt = DateTime.UtcNow;
        StateHasChanged();
    }

    private async Task CheckAnswer()
    {
        if (string.IsNullOrWhiteSpace(userAnswer)) return;

        // Calculate answer time
        answerTime = DateTime.UtcNow - cardShownAt;

        var possibleAnswers = new List<string> { currentCard.Card.TargetSentence.Text };
        var evaluation = AnswerEvaluator.Evaluate(userAnswer, possibleAnswers);

        isCorrect = evaluation.Quality != AnswerQuality.Wrong;
        if (isCorrect)
        {
            expEarned = ExpCalculator.CalculateEarnedExp(currentCard.Card, currentCard.State.Repetitions);
            totalExp += expEarned.Value;
        }
        else
        {
            expEarned = null;
        }

        Srs.Review(currentCard.State, (int)evaluation.Quality);
        validationMessage = BuildFeedbackMessage(evaluation);

        await Api.UpdateUserCardState(currentCard.State, expEarned ?? 0);

        // Update counters
        newCount = cards.Count(c => c.State.Repetitions == 0);
        reviewCount = cards.Count(c => c.State.Repetitions > 0);

        StartCountdown(3);
    }

    private void StartCountdown(int seconds)
    {
        countdown = seconds;

        countdownTimer = new System.Timers.Timer(1000); // 1 second
        countdownTimer.Elapsed += (s, e) =>
        {
            countdown--;
            InvokeAsync(StateHasChanged);

            if (countdown <= 0)
            {
                countdownTimer.Stop();
                InvokeAsync(NextCard);
            }
        };
        countdownTimer.Start();
    }

    private void RestartSession()
    {
        // reload everything fresh
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }
    private void ReturnToReview()
    {
        Navigation.NavigateTo(Routes.SessionSelect);
    }

    private string BuildFeedbackMessage(AnswerEvaluation evaluation)
    {
        var sb = new StringBuilder();

        if (evaluation.Quality > AnswerQuality.Wrong)
            sb.Append("✅ Correto!");
        else if (evaluation.Quality == AnswerQuality.Wrong)
            sb.Append("❌ Tente de novo.");

        if (evaluation.Quality < AnswerQuality.Perfect)
            sb.Append($" Resposta mais próxima: {evaluation.ClosestMatch}");

        return sb.ToString();
    }
}
