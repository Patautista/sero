@using System.Text
@using Business.ViewModel
@using CommunityToolkit.Maui.Alerts;
@using Domain
@using Domain.Events
@using MauiApp1.Services
@using MauiApp1.Services.Audio
@using static Business.AnswerEvaluator

@inject MauiSoundService SoundService
@inject DatabaseService Database

<div class="card-content transition-all duration-300 ease-in-out" style="filter: blur(@(isInputFocused ? "2px" : "0")); transform: scale(@(isInputFocused ? "0.95" : "1"));">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h1 class="text-xl font-medium">Transcreva o Áudio</h1>

        <!-- Floating EXP badge -->
        @if (_challengeState.ExpEarned.HasValue)
        {
            <div class="exp-badge">
                +@_challengeState.ExpEarned EXP
            </div>
        }
    </div>

    <!-- Resposta para card novo -->
    @if (CurrentCard.State.Repetitions == 0)
    {
        <div class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-3 rounded-lg shadow-md mb-4" role="alert">
            <p class="mb-0 text-sm font-medium">
                Novo card! Resposta: <strong class="font-semibold">@CurrentCard.Card.TargetSample.Text</strong>
            </p>
        </div>
    }
</div>

<!-- Botão para reproduzir áudio -->
<div class="w-full flex justify-center mb-5 mt-3">
    <ButtonPrimary OnClick="PlayAudio">
        <i class="fas fa-play"></i> Reproduzir
    </ButtonPrimary>
</div>

<input class="w-full form-control mb-2 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" @bind="_challengeState.UserAnswer" placeholder="O que você ouve?" @onfocus="() => isInputFocused = true" @onblur="() => isInputFocused = false" />

<div class="card-buttons transition-all duration-300 ease-in-out">
    <div class="flex justify-between">
        <div style="filter: blur(@(isInputFocused ? "2px" : "0")); transform: scale(@(isInputFocused ? "0.95" : "1"));">
            <ButtonSecondary OnClick="OnSkip">Pular</ButtonSecondary>
        </div>
        <ButtonPrimary OnClick="CheckAnswer">Conferir</ButtonPrimary>
    </div>

    @if (_challengeState.Feedback is not null)
    {
        <div class="mt-4">
            <div>
                <span>@_challengeState.Feedback.MainMessage</span>
            </div>
            @if (_challengeState.Feedback.ExpectedAnswer is not null)
            {
                <div class="text-sm text-gray-700 mt-2">
                    <strong>Resposta esperada:</strong> @_challengeState.Feedback.ExpectedAnswer
                </div>
            }
            @if (_challengeState.Feedback.Hint is not null)
            {
                <div class="text-xs text-gray-500 mt-1">
                    <strong>Dica:</strong> @_challengeState.Feedback.Hint
                </div>
            }
        </div>
    }

    @if (_challengeState.AnswerQuality != AnswerQuality.Perfect)
    {
        <div class="mt-4 text-center">
            <p class="text-sm text-gray-600 mb-2">Sua resposta estava correta?</p>
            <button class="btn btn-sm btn-outline-success" @onclick="ForceCorrectAnswer">
                Sim, aceitar como resposta correta
            </button>
        </div>
    }

    <NextCardCountdown Countdown="@_challengeState.Countdown" />
</div>

@code {
    [Parameter] public CardWithState CurrentCard { get; set; }
    [Parameter] public EventCallback<int> OnChallengeCompleted { get; set; }
    [Parameter] public EventCallback OnSkip { get; set; }

    private class ChallengeState
    {
        public string UserAnswer;
        public AnswerFeedback Feedback;
        public bool IsCorrect;
        public AnswerQuality AnswerQuality = AnswerQuality.Perfect;
        public int Countdown;
        public int? ExpEarned;
        public DateTime CardShownAt;
        public TimeSpan AnswerTime;
        public bool NextCardCalled = true;
    }
    private ChallengeState _challengeState = new();
    private System.Timers.Timer countdownTimer;
    private bool isInputFocused = false;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        ResetChallenge();
    }

    private void ResetChallenge()
    {
        countdownTimer?.Stop();
        _challengeState = new();
        _challengeState.CardShownAt = DateTime.UtcNow;
    }

    private async Task PlayAudio()
    {
        await PlayVoice(CurrentCard.Card.TargetSample.Text, CurrentCard.Card.TargetSample.Language);
    }

    private async Task CheckAnswer()
    {
        if (string.IsNullOrWhiteSpace(_challengeState.UserAnswer) || _challengeState.Countdown > 0) return;

        // Calculate answer time
        _challengeState.AnswerTime = DateTime.UtcNow - _challengeState.CardShownAt;

        var possibleAnswers = CurrentCard.Card.SentencesInTargetLanguage.Select(c => c.Text).ToList();
        var evaluation = AnswerEvaluator.Evaluate(_challengeState.UserAnswer, possibleAnswers);

        _challengeState.IsCorrect = evaluation.Quality != AnswerQuality.Wrong;
        _challengeState.AnswerQuality = evaluation.Quality;

        if (_challengeState.IsCorrect)
        {
            _challengeState.ExpEarned = ExpCalculator.CalculateEarnedExp(CurrentCard.Card, CurrentCard.State.Repetitions);
        }

        Srs.Review(CurrentCard.State, (int)evaluation.Quality);
        _challengeState.Feedback = AnswerEvaluator.BuildFeedbackMessage(evaluation, _challengeState.UserAnswer);

        await Database.UpdateUserCardState(CurrentCard.State, _challengeState.ExpEarned ?? 0);

        var evt = new CardAnsweredEvent(
            Guid.NewGuid(),
            CurrentCard.State.CardId,
            (int)_challengeState.AnswerTime.TotalMilliseconds,
            Correct: _challengeState.IsCorrect
        );

        await Database.SaveCardAnsweredAsync(evt);

        StartCountdown(_challengeState.AnswerQuality == AnswerQuality.Perfect ? 3 : 7);

        StateHasChanged();
    }

    private async Task PlayVoice(string text, string lang)
    {

        var res = await SoundService.PlayVoiceClip(text, CurrentCard.Card.TargetSample.Language);
        if (res)
        {
            var toast = Toast.Make("Reproduzindo áudio.", CommunityToolkit.Maui.Core.ToastDuration.Short, 14);
            await toast.Show(CancellationToken.None);
        }
        else
        {
            var toast = Toast.Make("Falha ao reproduzir áudio.", CommunityToolkit.Maui.Core.ToastDuration.Short, 14);
            await toast.Show(CancellationToken.None);
        }
    }

    private async Task ForceCorrectAnswer()
    {
        // Add the user's answer as a new alternative sentence
        var newSentence = new Sentence
        {
            MeaningId = CurrentCard.Card.NativeSample.MeaningId,
            Text = _challengeState.UserAnswer,
            Language = CurrentCard.Card.TargetSample.Language
        };
        await Database.AddAlternativeSentence(newSentence);

        // Treat as a correct answer from now on
        if (!_challengeState.IsCorrect)
        {
            _challengeState.IsCorrect = true;
            _challengeState.ExpEarned = ExpCalculator.CalculateEarnedExp(CurrentCard.Card, CurrentCard.State.Repetitions);

            // Review the card with a "correct" quality
            Srs.Review(CurrentCard.State, (int)AnswerQuality.Ok);
            await Database.UpdateUserCardState(CurrentCard.State, _challengeState.ExpEarned ?? 0);
        }
        _challengeState.Feedback.MainMessage = "✅ Correto! Sua resposta foi adicionada como alternativa.";

        var evt = new CardAnsweredEvent(
            Guid.NewGuid(),
            CurrentCard.State.CardId,
            (int)_challengeState.AnswerTime.TotalMilliseconds,
            Correct: true
        );
        await Database.SaveCardAnsweredAsync(evt);

        // Hide correction option and start countdown for next card
        _challengeState.AnswerQuality = AnswerQuality.Perfect;
        StartCountdown(5);
    }

    private void StartCountdown(int seconds)
    {
        _challengeState.Countdown = seconds;
        _challengeState.NextCardCalled = false;

        countdownTimer = new System.Timers.Timer(1000);
        countdownTimer.Elapsed += async (s, e) =>
        {
            _challengeState.Countdown--;
            await InvokeAsync(() =>
            {
                StateHasChanged();

                if (_challengeState.Countdown <= 0 && !_challengeState.NextCardCalled)
                {
                    _challengeState.NextCardCalled = true;
                    countdownTimer.Stop();
                    countdownTimer.Dispose();
                    countdownTimer = null;

                    OnChallengeCompleted.InvokeAsync(_challengeState.ExpEarned ?? 0);
                }
            });
        };
        countdownTimer.Start();
    }
}
