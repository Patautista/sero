@using System.Text
@using Business.Model
@using Domain
@using Domain.Events
@using MauiApp1.Services
@using MauiApp1.Services.Audio
@inject Business.AnswerEvaluator AnswerEvaluator
@inject MauiSoundService SoundService
@inject DatabaseService Database
@inherits SmartComponent

@code {
    [Parameter] public EventCallback<int> OnChallengeCompleted { get; set; }
    [Parameter] public EventCallback OnSkip { get; set; }

    protected class ChallengeState
    {
        public string UserAnswer;
        public AnswerFeedback Feedback;
        public bool IsCorrect;
        public AnswerQuality AnswerQuality = AnswerQuality.Perfect;
        public int Countdown;
        public int? ExpEarned;
        public DateTime CardShownAt;
        public TimeSpan AnswerTime;
        public bool NextCardCalled = true;
    }

    protected ChallengeState _challengeState = new();
    protected System.Timers.Timer countdownTimer;
    protected bool isInputFocused = false;

    protected virtual string ChallengeTypeName { get; }
    protected virtual SrsCard CurrentSrsCard { get; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        ResetChallenge();
    }

    protected void ResetChallenge()
    {
        countdownTimer?.Stop();
        _challengeState = new();
        _challengeState.CardShownAt = DateTime.UtcNow;
    }

    protected async Task SkipCard()
    {
        var evt = new CardSkippedEvent(
            Guid.NewGuid(),
            ChallengeTypeName,
            CurrentSrsCard.CardId
        );

        await Database.SaveCardSkippedAsync(evt);
        await OnSkip.InvokeAsync(null);
    }

    protected async Task ForceCorrectAnswer()
    {
        var newSentence = new Sentence
        {
            MeaningId = CurrentSrsCard.NativeSample.MeaningId,
            Text = _challengeState.UserAnswer,
            Language = CurrentSrsCard.TargetSample.Language
        };
        await Database.AddAlternativeSentence(newSentence);

        if (!_challengeState.IsCorrect)
        {
            _challengeState.IsCorrect = true;
            _challengeState.ExpEarned = ExpCalculator.CalculateEarnedExp(CurrentSrsCard, CurrentSrsCard.Repetitions);

            Srs.Review(CurrentSrsCard, AnswerQuality.Ok);
            await Database.UpdateUserCardState(CurrentSrsCard, _challengeState.ExpEarned ?? 0);
        }

        _challengeState.Feedback = new AnswerFeedback
        {
            Quality = AnswerQuality.Perfect,
            ClosestMatch = _challengeState.UserAnswer,
            MainMessage = "✅ Correto! Sua resposta foi adicionada como alternativa.",
            ExpectedAnswer = null,
            Hint = null
        };

        var evt = new CardAnsweredEvent(
            Guid.NewGuid(),
            ChallengeTypeName,
            CurrentSrsCard.CardId,
            (int)_challengeState.AnswerTime.TotalMilliseconds,
            Correct: true
        );
        await Database.SaveCardAnsweredAsync(evt);

        _challengeState.AnswerQuality = AnswerQuality.Perfect;
        StartCountdown(5);
    }

    protected void StartCountdown(int seconds)
    {
        _challengeState.Countdown = seconds;
        _challengeState.NextCardCalled = false;

        countdownTimer = new System.Timers.Timer(1000);
        countdownTimer.Elapsed += async (s, e) =>
        {
            _challengeState.Countdown--;
            await InvokeAsync(() =>
            {
                StateHasChanged();

                if (_challengeState.Countdown <= 0 && !_challengeState.NextCardCalled)
                {
                    _challengeState.NextCardCalled = true;
                    countdownTimer.Stop();
                    countdownTimer.Dispose();
                    countdownTimer = null;

                    OnChallengeCompleted.InvokeAsync(_challengeState.ExpEarned ?? 0);
                }
            });
        };
        countdownTimer.Start();
    }

    protected async Task SaveCardAnsweredEvent(bool isCorrect)
    {
        var evt = new CardAnsweredEvent(
            Guid.NewGuid(),
            ChallengeTypeName,
            CurrentSrsCard.CardId,
            (int)_challengeState.AnswerTime.TotalMilliseconds,
            Correct: isCorrect
        );

        await Database.SaveCardAnsweredAsync(evt);
    }

    public void Dispose()
    {
        countdownTimer?.Stop();
        countdownTimer?.Dispose();
    }
}