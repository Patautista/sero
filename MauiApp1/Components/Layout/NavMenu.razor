@using System.Globalization
@using Business.Interfaces
@using Infrastructure.Services
@using Business.MobileConfig
@inject MauiApp1.Services.DatabaseService DatabaseService
@inject ISettingsService SettingsService
@inject NavigationManager Navigation

<div class="top-bar bg-white shadow-sm px-4 py-2 sticky top-0 z-50 lg:hidden flex justify-between items-center">
    <a class="navbar-brand text-indigo-700 text-xl font-bold" href="">Triolingo</a>
    
    <!-- Language Picker in Mobile Top Bar -->
    @if (_availableLanguages.Count > 0)
    {
        <div class="flex-1 max-w-xs mx-3">
            <select @bind="_selectedLanguage" 
                    @bind:after="OnLanguageChanged"
                    class="w-full p-1.5 rounded-lg border border-indigo-300 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                @foreach (var lang in _availableLanguages.OrderBy(l => l))
                {
                    var displayName = GetLanguageFlag(lang) + " " + GetLanguageDisplayName(lang);
                    <option value="@lang">@displayName</option>
                }
            </select>
        </div>
    }
    
    <button class="hamburger-button focus:outline-none" @onclick="ToggleNavMenu">
        <span class="block bg-indigo-700 h-1 w-6 my-1 rounded-full transition-transform duration-300 ease-in-out" style="@(isNavOpen ? "transform: rotate(45deg) translate(5px, 5px);" : "")"></span>
        <span class="block bg-indigo-700 h-1 w-6 my-1 rounded-full transition-transform duration-300 ease-in-out" style="@(isNavOpen ? "opacity: 0;" : "")"></span>
        <span class="block bg-indigo-700 h-1 w-6 my-1 rounded-full transition-transform duration-300 ease-in-out" style="@(isNavOpen ? "transform: rotate(-45deg) translate(5px, -5px);" : "")"></span>
    </button>
</div>

<div class="@(isNavOpen ? "nav-menu-container-open" : "nav-menu-container-closed")
            flex-col transition-all duration-300 ease-in-out
            fixed inset-0 bg-white z-40
            lg:relative lg:flex-row lg:items-center lg:justify-start lg:py-0 lg:px-4 lg:bg-transparent">
    
    <div class="lg:hidden flex items-center justify-between p-4 border-b border-gray-200">
        <h2 class="text-2xl font-bold text-indigo-700">Menu</h2>
        <button class="text-3xl text-gray-500 cursor-pointer" @onclick="ToggleNavMenu">
            &times;
        </button>
    </div>

    <!-- Language Picker for Desktop -->
    @if (_availableLanguages.Count > 0)
    {
        <div class="hidden lg:block nav-item px-3 py-2">
            <select @bind="_selectedLanguage" 
                    @bind:after="OnLanguageChanged"
                    class="p-2 rounded-lg border border-indigo-300 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white hover:bg-indigo-50 transition-colors duration-200">
                @foreach (var lang in _availableLanguages.OrderBy(l => l))
                {
                    var displayName = GetLanguageFlag(lang) + " " + GetLanguageDisplayName(lang);
                    <option value="@lang">@displayName</option>
                }
            </select>
        </div>
    }

    <nav class="flex-column lg:flex-row">
        <div class="nav-item px-3 py-2">
            <NavLink class="nav-link text-lg font-medium text-gray-700 hover:bg-indigo-100 rounded-lg px-4 py-2 transition-colors duration-200"
                     href="@Routes.SessionSelect" Match="NavLinkMatch.All" @onclick="CloseNavMenu">
                <span class="bi bi-card-text-nav-menu" aria-hidden="true"></span> Home
            </NavLink>
        </div>
        <div class="nav-item px-3 py-2">
            <NavLink class="nav-link text-lg font-medium text-gray-700 hover:bg-indigo-100 rounded-lg px-4 py-2 transition-colors duration-200"
                     href="@Routes.Dashboard" Match="NavLinkMatch.All" @onclick="CloseNavMenu">
                <span class="bi bi-gear-fill-nav-menu" aria-hidden="true"></span> Estatísticas
            </NavLink>
        </div>
        <div class="nav-item px-3 py-2">
            <NavLink class="nav-link text-lg font-medium text-gray-700 hover:bg-indigo-100 rounded-lg px-4 py-2 transition-colors duration-200"
                     href="/analysis" Match="NavLinkMatch.All" @onclick="CloseNavMenu">
                <span class="bi bi-gear-fill-nav-menu" aria-hidden="true"></span> Análise
            </NavLink>
        </div>
        <div class="nav-item px-3 py-2">
            <NavLink class="nav-link text-lg font-medium text-gray-700 hover:bg-indigo-100 rounded-lg px-4 py-2 transition-colors duration-200"
                     href="@Routes.DecksView" Match="NavLinkMatch.All" @onclick="CloseNavMenu">
                <span class="bi bi-collection-nav-menu" aria-hidden="true"></span> Visualizar Decks
            </NavLink>
        </div>
        <div class="nav-item px-3 py-2">
            <NavLink class="nav-link text-lg font-medium text-gray-700 hover:bg-indigo-100 rounded-lg px-4 py-2 transition-colors duration-200"
                     href="@Routes.Settings" Match="NavLinkMatch.All" @onclick="CloseNavMenu">
                <span class="bi bi-gear-fill-nav-menu" aria-hidden="true"></span> Configuração
            </NavLink>
        </div>
    </nav>
</div>

@code {
    private bool isNavOpen = false;
    private List<string> _availableLanguages = new();
    private string _selectedLanguage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableLanguages();
        
        // Load current target language from StudyConfig
        var config = SettingsService.StudyConfig.Value;
        _selectedLanguage = config?.SelectedLanguage?.Target?.TwoLetterISOLanguageName ?? string.Empty;
        
        // If no language is set but we have available languages, set the first one
        if (string.IsNullOrEmpty(_selectedLanguage) && _availableLanguages.Any())
        {
            _selectedLanguage = _availableLanguages.First();
            await SetTargetLanguage(_selectedLanguage);
        }
    }

    private async Task LoadAvailableLanguages()
    {
        // Get languages from decks that the user is actually studying
        var deckLanguages = await DatabaseService.GetDistinctTargetLanguagesAsync();
        
        // Filter to only include languages that are in the AvailabilityService.TargetLanguages
        _availableLanguages = deckLanguages
            .Where(lang => AvailabilityService.TargetLanguages.Contains(lang))
            .ToList();
    }

    private async Task OnLanguageChanged()
    {
        if (string.IsNullOrEmpty(_selectedLanguage))
            return;
            
        await SetTargetLanguage(_selectedLanguage);
        
        // Refresh the current page to apply the new target language
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }

    private async Task SetTargetLanguage(string languageCode)
    {
        var config = SettingsService.StudyConfig.Value ?? StudyConfig.Default;
        
        // Ensure SelectedLanguage is initialized
        config.SelectedLanguage ??= new LanguagePair();
        
        // Keep the source language, update only the target
        var sourceLanguage = config.SelectedLanguage.Source ?? new CultureInfo("pt");
        
        // Set the target language
        config.SelectedLanguage.Source = sourceLanguage;
        config.SelectedLanguage.Target = new CultureInfo(languageCode);
        config.SelectedLanguageCode = $"{sourceLanguage.TwoLetterISOLanguageName}-{languageCode}";
        
        // Also update the filter for deck/RSS feed filtering
        config.SelectedTargetLanguageFilter = languageCode;
        
        SettingsService.StudyConfig.Update(config);
    }

    private string GetLanguageDisplayName(string languageCode)
    {
        try
        {
            var culture = new CultureInfo(languageCode);
            return culture.DisplayName;
        }
        catch
        {
            return languageCode.ToUpperInvariant();
        }
    }

    private string GetLanguageFlag(string languageCode)
    {
        // Use the codes from AvailabilityService
        return languageCode switch
        {
            AvailableCodes.English => "🇬🇧",
            AvailableCodes.Portuguese => "🇵🇹",
            AvailableCodes.Italian => "🇮🇹",
            AvailableCodes.Norwegian => "🇳🇴",
            AvailableCodes.Vietnamese => "🇻🇳",
            AvailableCodes.Chinese => "🇨🇳",
            AvailableCodes.German => "🇩🇪",
            _ => "🌐"
        };
    }

    private void ToggleNavMenu()
    {
        isNavOpen = !isNavOpen;
    }

    private void CloseNavMenu()
    {
        if (isNavOpen)
        {
            isNavOpen = false;
        }
    }
}

<style>
    /* Mobile styles for the hamburger menu */
    .nav-menu-container-closed {
        transform: translateX(-100%);
    }

    .nav-menu-container-open {
        transform: translateX(0);
    }
    
    .nav-link.active {
        background-color: #e0e7ff; /* Tailwind's indigo-100 */
        color: #4f46e5; /* Tailwind's indigo-600 */
    }

    /* Desktop styles */
    @@media (min-width: 1024px) {
        .top-bar {
            display: none;
        }
        
        .nav-menu-container-closed, .nav-menu-container-open {
            display: flex;
            position: relative;
            transform: none;
            background-color: transparent;
        }

        .nav-menu-container-closed nav, .nav-menu-container-open nav {
            flex-direction: row;
        }
    }
</style>