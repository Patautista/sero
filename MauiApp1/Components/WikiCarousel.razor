@using System.Net.Http.Json
@using Microsoft.Maui.ApplicationModel
@inject HttpClient Http
@inherits SmartComponent

<div class="p-2 flex justify-center w-full max-w-6xl mx-auto">
    <LoadingSpinner IsLoading="_isLoading">
        <RadzenCarousel Style="height:100%;width:100%;">
            <Items>
                @foreach (var article in _articles)
                {
                    <RadzenCarouselItem>
                        <div @onclick="() => OpenArticle(article.Content_Urls.Desktop.Page)"
                             class="block bg-white shadow-md rounded-xl p-4 hover:shadow-lg transition h-full flex flex-col cursor-pointer">
                            @* Added flex-col for consistent vertical stacking *@

                            <h3 class="text-xl font-semibold mb-2 line-clamp-2">@article.Title</h3> @* Added line-clamp to prevent oversized titles from breaking layout *@

                            @if (!string.IsNullOrEmpty(article.Thumbnail?.Source))
                            {
                                <img src="@article.Thumbnail.Source" alt="@article.Title"
                                     class="max-h-40 object-cover w-full mb-2 rounded-md mx-auto" /> @* Added object-cover and w-full for better image handling *@
                            }

                            <p class="text-gray-700 flex-grow overflow-hidden line-clamp-3">@article.Extract</p> @* Added line-clamp for extract too, and flex-grow to ensure all cards are same height if content is short *@
                        </div>
                    </RadzenCarouselItem>
                }
            </Items>
        </RadzenCarousel>
    </LoadingSpinner>
</div>

@code {
    private List<WikiArticle> _articles;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        _articles = new List<WikiArticle>();

        for (int i = 0; i < 3; i++)
        {
            var article = await GetRandomArticleAsync(TargetLanguageCode);
            if (article != null) _articles.Add(article);
        }
        _isLoading = false;
        Console.WriteLine($"Total artigos carregados: {_articles.Count}");
    }

    private async Task<WikiArticle> GetRandomArticleAsync(string lang)
    {
        var url = $"https://{lang}.wikipedia.org/api/rest_v1/page/random/summary";

        var request = new HttpRequestMessage(HttpMethod.Get, url);
        request.Headers.UserAgent.ParseAdd("TriolingoApp/1.0 (https://github.com/tuapp)");

        var response = await Http.SendAsync(request);

        response.EnsureSuccessStatusCode();

        return await response.Content.ReadFromJsonAsync<WikiArticle>();
    }

    private async Task OpenArticle(string url)
    {
        try
        {
            await Browser.Default.OpenAsync(url, BrowserLaunchMode.SystemPreferred);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening article: {ex.Message}");
        }
    }

    public class WikiArticle
    {
        public string Title { get; set; }
        public string Extract { get; set; }
        public WikiUrls Content_Urls { get; set; }
        public WikiImage Thumbnail { get; set; }
    }

    public class WikiUrls
    {
        public WikiDesktop Desktop { get; set; }
    }

    public class WikiDesktop
    {
        public string Page { get; set; }
    }

    public class WikiImage
    {
        public string Source { get; set; }
    }
}
